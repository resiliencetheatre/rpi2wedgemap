import{_ as A,U as f,o as r,c as l,a as s,n as v,h as k,v as P,b as u,F as x,f as b,t as h,k as U,l as D,e as M,w as T,T as I,W as C,N as F,D as g,r as S,d as N,m as y,p as j,q as B,G as R,s as V}from"./app-CqTJZnNE.js";const Z={name:"MessagesSidebar",props:{peers:Object,conversations:Array,selectedDestinationHash:String},data(){return{tab:"conversations",conversationsSearchTerm:"",peersSearchTerm:""}},methods:{onConversationClick(e){this.$emit("conversation-click",e)},onPeerClick(e){this.$emit("peer-click",e)},formatTimeAgo:function(e){return f.formatTimeAgo(e)}},computed:{searchedConversations(){return this.conversations.filter(e=>{var n,d;const t=this.conversationsSearchTerm.toLowerCase(),i=e.display_name.toLowerCase().includes(t),c=((d=(n=e.custom_display_name)==null?void 0:n.toLowerCase())==null?void 0:d.includes(t))===!0,a=e.destination_hash.toLowerCase().includes(t);return i||c||a})},peersCount(){return Object.keys(this.peers).length},peersOrderedByLatestAnnounce(){return Object.values(this.peers).sort(function(t,i){const c=new Date(t.updated_at).getTime();return new Date(i.updated_at).getTime()-c})},searchedPeers(){return this.peersOrderedByLatestAnnounce.filter(e=>{var n,d;const t=this.peersSearchTerm.toLowerCase(),i=e.display_name.toLowerCase().includes(t),c=((d=(n=e.custom_display_name)==null?void 0:n.toLowerCase())==null?void 0:d.includes(t))===!0,a=e.destination_hash.toLowerCase().includes(t);return i||c||a})}}},H={class:"flex flex-col w-80 min-w-80"},O={class:"bg-white border-b border-r border-gray-200"},z={class:"-mb-px flex"},$={key:0,class:"flex-1 flex flex-col bg-white border-r overflow-hidden"},E={key:0,class:"p-1 border-b border-gray-300"},W=["placeholder"],q={class:"flex h-full overflow-y-auto"},K={key:0,class:"w-full"},Q=["onClick"],Y=s("div",{class:"my-auto mr-2"},[s("div",{class:"bg-gray-200 text-gray-500 p-2 rounded"},[s("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-6 h-6"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z"})])])],-1),G={class:"mr-auto"},J={class:"text-gray-500 text-sm"},X={key:0,class:"my-auto ml-2 mr-2"},ee=s("div",{class:"bg-blue-500 rounded-full p-1"},null,-1),se=[ee],te={key:1,class:"my-auto ml-2 mr-2"},oe=s("div",{class:"bg-red-500 rounded-full p-1"},null,-1),ne=[oe],ie={key:1,class:"mx-auto my-auto text-center leading-5"},ae={key:0,class:"flex flex-col"},re=s("div",{class:"mx-auto mb-1"},[s("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"size-6"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M2.25 13.5h3.86a2.25 2.25 0 0 1 2.012 1.244l.256.512a2.25 2.25 0 0 0 2.013 1.244h3.218a2.25 2.25 0 0 0 2.013-1.244l.256-.512a2.25 2.25 0 0 1 2.013-1.244h3.859m-19.5.338V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18v-4.162c0-.224-.034-.447-.1-.661L19.24 5.338a2.25 2.25 0 0 0-2.15-1.588H6.911a2.25 2.25 0 0 0-2.15 1.588L2.35 13.177a2.25 2.25 0 0 0-.1.661Z"})])],-1),le=s("div",{class:"font-semibold"},"No Conversations",-1),de=s("div",null,"Discover peers on the Announces tab",-1),ce=[re,le,de],ue={key:1,class:"flex flex-col"},he=s("div",{class:"mx-auto mb-1"},[s("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-6 h-6"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"})])],-1),me=s("div",{class:"font-semibold"},"No Search Results",-1),ge=s("div",null,"Your search didn't match any Conversations!",-1),fe=[he,me,ge],_e={key:1,class:"flex-1 flex flex-col bg-white border-r overflow-hidden"},ve={key:0,class:"p-1 border-b border-gray-300"},we=["placeholder"],pe={class:"flex h-full overflow-y-auto"},xe={key:0,class:"w-full"},ye=["onClick"],be=s("div",{class:"my-auto mr-2"},[s("div",{class:"bg-gray-200 text-gray-500 p-2 rounded"},[s("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-6 h-6"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z"})])])],-1),ke={class:"text-gray-900"},Me={class:"text-gray-500 text-sm"},Ce={key:1,class:"mx-auto my-auto text-center leading-5"},Ae={key:0,class:"flex flex-col"},Pe=s("div",{class:"mx-auto mb-1"},[s("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-6 h-6"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z"})])],-1),Se=s("div",{class:"font-semibold"},"No Peers Discovered",-1),Le=s("div",null,"Waiting for someone to announce!",-1),Be=[Pe,Se,Le],Re={key:1,class:"flex flex-col"},Te=s("div",{class:"mx-auto mb-1"},[s("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-6 h-6"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"})])],-1),Ue=s("div",{class:"font-semibold"},"No Search Results",-1),De=s("div",null,"Your search didn't match any Peers!",-1),Ie=[Te,Ue,De];function Fe(e,t,i,c,a,n){return r(),l("div",H,[s("div",O,[s("div",z,[s("div",{onClick:t[0]||(t[0]=d=>a.tab="conversations"),class:v(["w-full border-b-2 py-3 px-1 text-center text-sm font-medium cursor-pointer",[a.tab==="conversations"?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700"]])},"Conversations",2),s("div",{onClick:t[1]||(t[1]=d=>a.tab="announces"),class:v(["w-full border-b-2 py-3 px-1 text-center text-sm font-medium cursor-pointer",[a.tab==="announces"?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700"]])},"Announces",2)])]),a.tab==="conversations"?(r(),l("div",$,[i.conversations.length>0?(r(),l("div",E,[k(s("input",{"onUpdate:modelValue":t[2]||(t[2]=d=>a.conversationsSearchTerm=d),type:"text",placeholder:`Search ${i.conversations.length} Conversations...`,class:"bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"},null,8,W),[[P,a.conversationsSearchTerm]])])):u("",!0),s("div",q,[n.searchedConversations.length>0?(r(),l("div",K,[(r(!0),l(x,null,b(n.searchedConversations,d=>(r(),l("div",{onClick:o=>n.onConversationClick(d),class:v(["flex cursor-pointer p-2 border-l-2",[d.destination_hash===i.selectedDestinationHash?"bg-gray-100 border-blue-500":"bg-white border-transparent hover:bg-gray-50 hover:border-gray-200"]])},[Y,s("div",G,[s("div",{class:v(["text-gray-900",{"font-semibold":d.is_unread||d.failed_messages_count>0}])},h(d.custom_display_name??d.display_name),3),s("div",J,h(n.formatTimeAgo(d.updated_at)),1)]),d.is_unread?(r(),l("div",X,se)):d.failed_messages_count?(r(),l("div",te,ne)):u("",!0)],10,Q))),256))])):(r(),l("div",ie,[i.conversations.length===0?(r(),l("div",ae,ce)):u("",!0),a.conversationsSearchTerm!==""&&i.conversations.length>0?(r(),l("div",ue,fe)):u("",!0)]))])])):u("",!0),a.tab==="announces"?(r(),l("div",_e,[n.peersCount>0?(r(),l("div",ve,[k(s("input",{"onUpdate:modelValue":t[3]||(t[3]=d=>a.peersSearchTerm=d),type:"text",placeholder:`Search ${n.peersCount} recent announces...`,class:"bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"},null,8,we),[[P,a.peersSearchTerm]])])):u("",!0),s("div",pe,[n.searchedPeers.length>0?(r(),l("div",xe,[(r(!0),l(x,null,b(n.searchedPeers,d=>(r(),l("div",{onClick:o=>n.onPeerClick(d),class:v(["flex cursor-pointer p-2 border-l-2",[d.destination_hash===i.selectedDestinationHash?"bg-gray-100 border-blue-500":"bg-white border-transparent hover:bg-gray-50 hover:border-gray-200"]])},[be,s("div",null,[s("div",ke,h(d.custom_display_name??d.display_name),1),s("div",Me,h(n.formatTimeAgo(d.updated_at)),1)])],10,ye))),256))])):(r(),l("div",Ce,[n.peersCount===0?(r(),l("div",Ae,Be)):u("",!0),a.peersSearchTerm!==""&&n.peersCount>0?(r(),l("div",Re,Ie)):u("",!0)]))])])):u("",!0)])}const Ne=A(Z,[["render",Fe]]),je={name:"AddAudioButton",props:{isRecordingAudioAttachment:Boolean},data(){return{isShowingMenu:!1}},methods:{showMenu(){this.isShowingMenu=!0},hideMenu(){this.isShowingMenu=!1},startRecordingAudioAttachment(e){this.isShowingMenu=!1,this.$emit("start-recording",e)},startRecordingCodec2(e){this.startRecordingAudioAttachment({codec:"codec2",mode:e})},stopRecordingAudioAttachment(){this.isShowingMenu=!1,this.$emit("stop-recording")}}},Ve={class:"inline-flex rounded-md shadow-sm"},Ze=s("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",class:"size-5"},[s("path",{d:"M7 4a3 3 0 0 1 6 0v6a3 3 0 1 1-6 0V4Z"}),s("path",{d:"M5.5 9.643a.75.75 0 0 0-1.5 0V10c0 3.06 2.29 5.585 5.25 5.954V17.5h-1.5a.75.75 0 0 0 0 1.5h4.5a.75.75 0 0 0 0-1.5h-1.5v-1.546A6.001 6.001 0 0 0 16 10v-.357a.75.75 0 0 0-1.5 0V10a4.5 4.5 0 0 1-9 0v-.357Z"})],-1),He={class:"ml-1"},Oe=s("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",class:"size-5"},[s("path",{d:"M7 4a3 3 0 0 1 6 0v6a3 3 0 1 1-6 0V4Z"}),s("path",{d:"M5.5 9.643a.75.75 0 0 0-1.5 0V10c0 3.06 2.29 5.585 5.25 5.954V17.5h-1.5a.75.75 0 0 0 0 1.5h4.5a.75.75 0 0 0 0-1.5h-1.5v-1.546A6.001 6.001 0 0 0 16 10v-.357a.75.75 0 0 0-1.5 0V10a4.5 4.5 0 0 1-9 0v-.357Z"})],-1),ze=s("span",{class:"ml-1 hidden sm:inline-block"},"Add Voice",-1),$e=[Oe,ze],Ee={class:"relative block"},We={key:0,class:"absolute bottom-0 -ml-11 sm:right-0 sm:ml-0 z-10 mb-10 w-56 rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none"},qe={class:"py-1"};function Ke(e,t,i,c,a,n){const d=U("click-outside");return r(),l("div",Ve,[i.isRecordingAudioAttachment?(r(),l("button",{key:0,onClick:t[0]||(t[0]=(...o)=>n.stopRecordingAudioAttachment&&n.stopRecordingAudioAttachment(...o)),type:"button",class:"my-auto mr-1 inline-flex items-center gap-x-1 rounded-md bg-red-500 px-2.5 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-red-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-red-500"},[Ze,s("span",He,[D(e.$slots,"default")])])):(r(),l("button",{key:1,onClick:t[1]||(t[1]=(...o)=>n.showMenu&&n.showMenu(...o)),type:"button",class:"my-auto mr-1 inline-flex items-center gap-x-1 rounded-md bg-gray-500 px-2.5 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-gray-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-500"},$e)),s("div",Ee,[M(I,{"enter-active-class":"transition ease-out duration-100","enter-from-class":"transform opacity-0 scale-95","enter-to-class":"transform opacity-100 scale-100","leave-active-class":"transition ease-in duration-75","leave-from-class":"transform opacity-100 scale-100","leave-to-class":"transform opacity-0 scale-95"},{default:T(()=>[a.isShowingMenu?k((r(),l("div",We,[s("div",qe,[s("button",{onClick:t[2]||(t[2]=o=>n.startRecordingCodec2("1200")),type:"button",class:"w-full block text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"},"Codec2 (Low Quality)"),s("button",{onClick:t[3]||(t[3]=o=>n.startRecordingCodec2("3200")),type:"button",class:"w-full block text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"},"Codec2 (Medium Quality)")])])),[[d,n.hideMenu]]):u("",!0)]),_:1})])])}const Qe=A(je,[["render",Ke]]),Ye={name:"ConversationViewer",components:{AddAudioButton:Qe},props:{myLxmfAddressHash:String,selectedPeer:Object,conversations:Array},data(){return{selectedPeerPath:null,lxmfMessagesRequestSequence:0,chatItems:[],isLoadingPrevious:!1,hasMorePrevious:!0,newMessageText:"",newMessageImage:null,newMessageImageUrl:null,newMessageAudio:null,newMessageFiles:[],isSendingMessage:!1,autoScrollOnNewMessage:!0,isRecordingAudioAttachment:!1,audioAttachmentMicrophoneRecorder:null,audioAttachmentRecordingStartedAt:null,audioAttachmentRecordingDuration:null,audioAttachmentRecordingTimer:null,lxmfMessageAudioAttachmentCache:{},lxmfAudioModeToCodec2ModeMap:{1:"450PWB",2:"450",3:"700C",4:"1200",5:"1300",6:"1400",7:"1600",8:"2400",9:"3200"}}},beforeUnmount(){C.off("message",this.onWebsocketMessage)},mounted(){C.on("message",this.onWebsocketMessage)},methods:{close(){this.$emit("close")},onMessagesScroll(e){const t=e.target,i=t.scrollTop===t.scrollHeight-t.offsetHeight;this.autoScrollOnNewMessage=i,t.scrollTop<=500&&this.loadPrevious()},async initialLoad(){this.chatItems=[],this.hasMorePrevious=!0,this.selectedPeer&&(this.getPeerPath(),await this.loadPrevious(),this.scrollMessagesToBottom())},async loadPrevious(){if(!this.isLoadingPrevious){this.isLoadingPrevious=!0;try{const e=++this.lxmfMessagesRequestSequence,t=30,i=await window.axios.get(`/api/v1/lxmf-messages/conversation/${this.selectedPeer.destination_hash}`,{params:{count:t,order:"desc",after_id:this.oldestMessageId}});if(e!==this.lxmfMessagesRequestSequence){console.log("ignoring response for previous lxmf messages request");return}const c=[],a=i.data.lxmf_messages;for(const n of a)c.push({type:"lxmf_message",is_outbound:this.myLxmfAddressHash===n.source_hash,lxmf_message:n});for(const n of c)this.chatItems.unshift(n);c.length<t&&(this.hasMorePrevious=!1)}catch{}finally{this.isLoadingPrevious=!1}}},async onWebsocketMessage(e){const t=JSON.parse(e.data);switch(t.type){case"lxmf.delivery":{this.onLxmfMessageReceived(t.lxmf_message),await this.getPeerPath();break}case"lxmf_message_created":{this.onLxmfMessageCreated(t.lxmf_message),await this.getPeerPath();break}case"lxmf_message_state_updated":{this.onLxmfMessageUpdated(t.lxmf_message);break}case"lxmf_message_deleted":{this.onLxmfMessageDeleted(t.hash);break}}},onLxmfMessageReceived(e){var t;if(this.chatItems.push({type:"lxmf_message",lxmf_message:e}),e.source_hash===((t=this.selectedPeer)==null?void 0:t.destination_hash)){const i=this.findConversation(this.selectedPeer.destination_hash);i&&this.markConversationAsRead(i)}document.hasFocus()||F.showNewMessageNotification(),this.autoScrollOnNewMessage&&this.scrollMessagesToBottom()},onLxmfMessageCreated(e){this.isLxmfMessageInUi(e.hash)||this.chatItems.push({type:"lxmf_message",lxmf_message:e,is_outbound:!0})},onLxmfMessageUpdated(e){const t=e.hash,i=this.chatItems.findIndex(c=>{var a;return((a=c.lxmf_message)==null?void 0:a.hash)===t});if(i===-1){console.log("did not find existing chat item index for lxmf message hash: "+e.hash);return}this.chatItems[i].lxmf_message=e},onLxmfMessageDeleted(e){e&&(this.chatItems=this.chatItems.filter(t=>{var i;return((i=t.lxmf_message)==null?void 0:i.hash)!==e}))},async getPeerPath(){if(this.selectedPeerPath=null,this.selectedPeer)try{const e=await window.axios.get(`/api/v1/destination/${this.selectedPeer.destination_hash}/path`);this.selectedPeerPath=e.data.path}catch(e){console.log(e)}},onDestinationPathClick(e){g.alert(`${e.hops} ${e.hops===1?"hop":"hops"} away via ${e.next_hop_interface}`)},scrollMessagesToBottom:function(){this.$nextTick(()=>{setTimeout(()=>{const e=document.getElementById("messages");e&&(e.scrollTop=e.scrollHeight)},0)})},isLxmfMessageInUi:function(e){return this.chatItems.findIndex(t=>{var i;return((i=t.lxmf_message)==null?void 0:i.hash)===e})!==-1},async getCustomDisplayName(){if(this.selectedPeer)try{const e=await window.axios.get(`/api/v1/destination/${this.selectedPeer.destination_hash}/custom-display-name`);this.selectedPeer.custom_display_name=e.data.custom_display_name}catch(e){console.log(e)}},async updateCustomDisplayName(){if(!this.selectedPeer)return;const e=await g.prompt("Enter a custom display name");if(e!=null)try{await axios.post(`/api/v1/destination/${this.selectedPeer.destination_hash}/custom-display-name/update`,{display_name:e}),await this.getCustomDisplayName(),this.$emit("reload-conversations")}catch(t){console.log(t),g.alert("Failed to update display name")}},async deleteConversation(){if(this.selectedPeer&&confirm("Are you sure you want to delete all messages from this conversation? This can not be undone!")){try{await window.axios.delete(`/api/v1/lxmf-messages/conversation/${this.selectedPeer.destination_hash}`)}catch(e){g.alert("failed to delete conversation"),console.log(e)}await this.initialLoad(),this.$emit("reload-conversations")}},onChatItemClick:function(e){e.is_actions_expanded?e.is_actions_expanded=!1:e.is_actions_expanded=!0},openImage:async function(e){const t=await(await fetch(e)).blob(),i=window.URL.createObjectURL(t);window.open(i)},downloadFileFromBase64:async function(e,t){const i=atob(t),c=new Array(i.length);for(let m=0;m<i.length;m++)c[m]=i.charCodeAt(m);const a=new Uint8Array(c),n=new Blob([a]),d=URL.createObjectURL(n),o=document.createElement("a");o.href=d,o.download=e,o.style.display="none",document.body.append(o),o.click(),o.remove(),setTimeout(()=>URL.revokeObjectURL(d),1e4)},async processAudioForSelectedPeerChatItems(){var e,t;for(const i of this.selectedPeerChatItems){if(!((t=(e=i.lxmf_message)==null?void 0:e.fields)!=null&&t.audio)||this.lxmfMessageAudioAttachmentCache[i.lxmf_message.hash])continue;const c=await this.decodeLxmfAudioFieldToBlobUrl(i.lxmf_message.fields.audio);c&&(this.lxmfMessageAudioAttachmentCache[i.lxmf_message.hash]=c)}},async decodeLxmfAudioFieldToBlobUrl(e){try{const t=e.audio_mode,i=e.audio_bytes;if(t===16)return this.decodeOpusAudioToBlobUrl(e.audio_bytes);const c=this.lxmfAudioModeToCodec2ModeMap[t];if(!c)return console.log("unsupported audio mode: "+t),null;const a=this.base64ToArrayBuffer(i),n=await Codec2Lib.runDecode(c,new Uint8Array(a)),d=await Codec2Lib.rawToWav(n),o=new Blob([d],{type:"audio/wav"});return URL.createObjectURL(o)}catch(t){return console.log(t),null}},async decodeOpusAudioToBlobUrl(e){try{const t=this.base64ToArrayBuffer(e),i=new Blob([t],{type:"audio/opus"});return URL.createObjectURL(i)}catch(t){return console.log(t),null}},base64ToArrayBuffer:function(e){return Uint8Array.from(atob(e),t=>t.charCodeAt(0))},async deleteChatItem(e,t=!0){try{if(t&&!confirm("Are you sure you want to delete this message? This can not be undone!")||e.type!=="lxmf_message")return;await window.axios.delete(`/api/v1/lxmf-messages/${e.lxmf_message.hash}`),this.chatItems=this.chatItems.filter(i=>{var c;return((c=i.lxmf_message)==null?void 0:c.hash)!==e.lxmf_message.hash})}catch{}},async sendMessage(){var c,a;if(this.canSendMessage&&this.selectedPeer){this.isSendingMessage=!0;try{const n={};var e=0;if(this.newMessageFiles.length>0){const w=[];for(const p of this.newMessageFiles)e+=p.size,w.push({file_name:p.name,file_bytes:f.arrayBufferToBase64(await p.arrayBuffer())});n.file_attachments=w}var t=0;this.newMessageImage&&(t=this.newMessageImage.size,n.image={image_type:this.newMessageImage.type.replace("image/",""),image_bytes:f.arrayBufferToBase64(await this.newMessageImage.arrayBuffer())});var i=0;this.newMessageAudio&&(i=this.newMessageAudio.size,n.audio={audio_mode:this.newMessageAudio.audio_mode,audio_bytes:f.arrayBufferToBase64(await this.newMessageAudio.audio_blob.arrayBuffer())});const o=this.newMessageText.length+e+t+i;if(o>1e3*900&&!confirm(`Your message exceeds 900KB (It's ${this.formatBytes(o)}). It may be rejected by the recipient unless they have increased their delivery limit. Do you want to try sending anyway?`))return;const m=await window.axios.post("/api/v1/lxmf-messages/send",{lxmf_message:{destination_hash:this.selectedPeer.destination_hash,content:this.newMessageText,fields:n}});this.isLxmfMessageInUi(m.data.lxmf_message.hash)||this.chatItems.push({type:"lxmf_message",lxmf_message:m.data.lxmf_message,is_outbound:!0}),this.scrollMessagesToBottom(),this.newMessageText="",this.newMessageImage=null,this.newMessageImageUrl=null,this.newMessageAudio=null,this.newMessageFiles=[],this.clearImageInput(),this.clearFileInput()}catch(n){const d=((a=(c=n.response)==null?void 0:c.data)==null?void 0:a.message)??"failed to send message";g.alert(d),console.log(n)}finally{this.isSendingMessage=!1}}},async retrySendingMessage(e){var t,i;await this.deleteChatItem(e,!1);try{const c=await window.axios.post("/api/v1/lxmf-messages/send",{lxmf_message:{destination_hash:e.lxmf_message.destination_hash,content:e.lxmf_message.content,fields:e.lxmf_message.fields}});this.isLxmfMessageInUi(c.data.lxmf_message.hash)||this.chatItems.push({type:"lxmf_message",lxmf_message:c.data.lxmf_message,is_outbound:!0}),this.scrollMessagesToBottom()}catch(c){const a=((i=(t=c.response)==null?void 0:t.data)==null?void 0:i.message)??"failed to send message";g.alert(a),console.log(c)}},formatTimeAgo:function(e){return f.formatTimeAgo(e)},formatBytes:function(e){return f.formatBytes(e)},onFileInputChange:function(e){for(const t of e.target.files)this.newMessageFiles.push(t)},clearFileInput:function(){this.$refs["file-input"].value=null},removeImageAttachment:function(){this.newMessageImage=null,this.newMessageImageUrl=null},onImageInputChange:function(e){if(e.target.files.length>0){this.newMessageImage=e.target.files[0];const t=new FileReader;t.onload=i=>{this.newMessageImageUrl=i.target.result},t.readAsDataURL(this.newMessageImage),this.clearImageInput()}},clearImageInput:function(){this.$refs["image-input"].value=null},async startRecordingAudioAttachment(e){if(!this.isRecordingAudioAttachment&&!(this.newMessageAudio&&!confirm("An audio recording is already attached. A new recording will replace it. Do you want to continue?")))switch(e.codec){case"codec2":{this.audioAttachmentMicrophoneRecorder=new Codec2MicrophoneRecorder,this.audioAttachmentMicrophoneRecorder.codec2Mode=e.mode,this.audioAttachmentRecordingStartedAt=Date.now(),this.isRecordingAudioAttachment=await this.audioAttachmentMicrophoneRecorder.start(),this.audioAttachmentRecordingDuration=f.formatMinutesSeconds(0),this.audioAttachmentRecordingTimer=setInterval(()=>{const i=(Date.now()-this.audioAttachmentRecordingStartedAt)/1e3;this.audioAttachmentRecordingDuration=f.formatMinutesSeconds(i)},1e3),this.isRecordingAudioAttachment||g.alert("failed to start recording");break}default:{g.alert(`Unhandled microphone recorder codec: ${e.codec}`);break}}},async stopRecordingAudioAttachment(){if(clearInterval(this.audioAttachmentRecordingTimer),!this.isRecordingAudioAttachment)return;this.isRecordingAudioAttachment=!1;const e=await this.audioAttachmentMicrophoneRecorder.stop();if(e.length===0)return;const t=this.audioAttachmentMicrophoneRecorder.codec2Mode,i=await Codec2Lib.runDecode(t,new Uint8Array(e)),c=await Codec2Lib.rawToWav(i),a=new Blob([c],{type:"audio/wav"});var n=null;switch(t){case"1200":{n=4;break}case"3200":{n=9;break}default:{g.alert(`Unhandled microphone recorder codec2Mode: ${t}`);return}}this.newMessageAudio={audio_mode:n,audio_blob:new Blob([e]),audio_wav_url:URL.createObjectURL(a)}},removeAudioAttachment:function(){confirm("Are you sure you want to remove this audio attachment?")&&(this.newMessageAudio=null)},removeFileAttachment:function(e){this.newMessageFiles=this.newMessageFiles.filter(t=>t!==e)},addNewLine:function(){this.newMessageText+=`
`},onEnterPressed:function(){if(this.isMobile){this.addNewLine();return}this.sendMessage()},onShiftEnterPressed:function(){this.addNewLine()},addFilesToMessage:function(){this.$refs["file-input"].click()},addImageToMessage:function(){this.$refs["image-input"].click()},findConversation:function(e){return this.conversations.find(t=>t.destination_hash===e)},async markConversationAsRead(e){e.is_unread=!1;try{await window.axios.get(`/api/v1/lxmf/conversations/${e.destination_hash}/mark-as-read`)}catch(t){console.log(t)}this.$emit("reload-conversations")},showSentMessageInfo:function(e){g.alert([`Created: ${f.convertUnixMillisToLocalDateTimeString(e.timestamp*1e3)}`,`Method: ${e.method??"unknown"}`].join(`
`))},showReceivedMessageInfo:function(e){const t=[`Sent: ${f.convertUnixMillisToLocalDateTimeString(e.timestamp*1e3)}`,`Received: ${f.convertDateTimeToLocalDateTimeString(new Date(e.created_at))}`,`Method: ${e.method??"unknown"}`];e.quality!=null&&t.push(`Signal Quality: ${e.quality}%`),e.rssi!=null&&t.push(`RSSI: ${e.rssi}dBm`),e.snr!=null&&t.push(`SNR: ${e.snr}dB`),g.alert(t.join(`
`))}},computed:{isMobile(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)},canSendMessage(){const e=this.newMessageText.trim();return!(e==null||e===""||this.isSendingMessage)},selectedPeerChatItems(){return this.selectedPeer?this.chatItems.filter(e=>{if(e.type==="lxmf_message"){const t=e.lxmf_message.source_hash===this.selectedPeer.destination_hash,i=e.lxmf_message.destination_hash===this.selectedPeer.destination_hash;return t||i}return!1}):[]},selectedPeerChatItemsReversed(){return this.selectedPeerChatItems.map(e=>e).reverse()},oldestMessageId(){return this.selectedPeerChatItems.length>0?this.selectedPeerChatItems[0].lxmf_message.id:null}},watch:{selectedPeer(){this.initialLoad()},async selectedPeerChatItems(){await this.processAudioForSelectedPeerChatItems()}}},Ge={key:0,class:"m-2 flex flex-col h-full border rounded-xl bg-white shadow overflow-hidden"},Je={class:"flex p-2 border-b border-gray-300"},Xe={key:0,class:"my-auto mr-1",title:"Custom Display Name"},es=s("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"size-4"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M9.568 3H5.25A2.25 2.25 0 0 0 3 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 0 0 5.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 0 0 9.568 3Z"}),s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6 6h.008v.008H6V6Z"})],-1),ss=[es],ts=["title"],os={class:"text-sm"},ns={class:"ml-auto my-auto mr-2"},is=["href"],as=s("div",{class:"flex text-gray-700 bg-gray-100 hover:bg-gray-200 p-2 rounded-full"},[s("div",null,[s("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-5 h-5"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 0 0 2.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 0 1-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 0 0-1.091-.852H4.5A2.25 2.25 0 0 0 2.25 4.5v2.25Z"})])])],-1),rs=[as],ls={class:"my-auto mr-2"},ds=s("div",{class:"flex text-gray-700 bg-gray-100 hover:bg-gray-200 p-2 rounded-full"},[s("div",null,[s("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-5 h-5"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"})])])],-1),cs=[ds],us={class:"my-auto mr-2"},hs=s("div",{class:"flex text-gray-700 bg-gray-100 hover:bg-gray-200 p-2 rounded-full"},[s("div",null,[s("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",class:"w-5 h-5"},[s("path",{d:"M6.28 5.22a.75.75 0 0 0-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 1 0 1.06 1.06L10 11.06l3.72 3.72a.75.75 0 1 0 1.06-1.06L11.06 10l3.72-3.72a.75.75 0 0 0-1.06-1.06L10 8.94 6.28 5.22Z"})])])],-1),ms=[hs],gs={key:0,class:"flex flex-col flex-col-reverse p-3"},fs=["onClick"],_s={class:"w-full space-y-0.5 px-2.5 py-1"},vs={key:0,style:{"white-space":"pre-wrap","word-break":"break-word","font-family":"inherit"}},ws={key:1},ps=["onClick","src"],xs={key:2,class:"pb-1"},ys={key:0,controls:"",class:"shadow rounded-full",style:{height:"54px"}},bs=["src"],ks={key:1,style:{"min-height":"54px"},class:"flex"},Ms=["onClick"],Cs=s("span",{class:"my-auto"},[s("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"size-6"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m9 9 10.5-3m0 6.553v3.75a2.25 2.25 0 0 1-1.632 2.163l-1.32.377a1.803 1.803 0 1 1-.99-3.467l2.31-.66a2.25 2.25 0 0 0 1.632-2.163Zm0 0V2.25L9 5.25v10.303m0 0v3.75a2.25 2.25 0 0 1-1.632 2.163l-1.32.377a1.803 1.803 0 0 1-.99-3.467l2.31-.66A2.25 2.25 0 0 0 9 15.553Z"})])],-1),As={class:"my-auto w-full"},Ps=s("span",{class:"my-auto"},[s("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-6 h-6"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3"})])],-1),Ss={key:3,class:"space-y-1"},Ls=["download","href"],Bs=s("div",{class:"my-auto"},[s("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-6 h-6"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m18.375 12.739-7.693 7.693a4.5 4.5 0 0 1-6.364-6.364l10.94-10.94A3 3 0 1 1 19.5 7.372L8.552 18.32m.009-.01-.01.01m5.699-9.941-7.81 7.81a1.5 1.5 0 0 0 2.112 2.13"})])],-1),Rs={class:"my-auto w-full"},Ts=s("div",{class:"my-auto"},[s("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-6 h-6"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3"})])],-1),Us={key:0,class:"border-t p-1 bg-[#efefef] text-white"},Ds=["onClick"],Is={class:"flex ml-auto space-x-1"},Fs={class:"my-auto"},Ns=["onClick"],js={key:0},Vs={key:1},Zs={key:2},Hs={key:3},Os=["onClick"],zs={key:0,class:"my-auto"},$s=s("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",class:"w-5 h-5"},[s("path",{"fill-rule":"evenodd",d:"M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 1 0-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 0 0-1.06 1.06l2.25 2.25a.75.75 0 0 0 1.14-.094l3.75-5.25Z","clip-rule":"evenodd"})],-1),Es=[$s],Ws={key:1,class:"my-auto"},qs=s("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",class:"w-5 h-5"},[s("path",{"fill-rule":"evenodd",d:"M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12ZM12 8.25a.75.75 0 0 1 .75.75v3.75a.75.75 0 0 1-1.5 0V9a.75.75 0 0 1 .75-.75Zm0 8.25a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z","clip-rule":"evenodd"})],-1),Ks=[qs],Qs={key:2,class:"my-auto"},Ys=s("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-5 h-5"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"})],-1),Gs=[Ys],Js={key:1,class:"text-xs text-gray-500 mt-0.5 flex flex-col"},Xs=["onClick"],et=s("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"size-6"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m15 11.25-3-3m0 0-3 3m3-3v7.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"})],-1),st=s("span",null,"Load Previous",-1),tt=[et,st],ot={class:"w-full border-gray-300 border-t p-2"},nt={class:"mx-auto"},it={key:0,class:"mb-2"},at={class:"w-32 h-32 rounded shadow border relative overflow-hidden"},rt=["src"],lt={class:"absolute top-0 right-0 p-1"},dt=s("div",{class:"flex text-gray-700 bg-gray-100 hover:bg-gray-200 p-1 rounded-full"},[s("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",class:"w-4 h-4"},[s("path",{d:"M6.28 5.22a.75.75 0 0 0-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 1 0 1.06 1.06L10 11.06l3.72 3.72a.75.75 0 1 0 1.06-1.06L11.06 10l3.72-3.72a.75.75 0 0 0-1.06-1.06L10 8.94 6.28 5.22Z"})])],-1),ct=[dt],ut={class:"absolute bottom-0 left-0 p-1"},ht={class:"bg-gray-100 rounded border text-sm px-1"},mt={key:1,class:"mb-2"},gt={class:"flex flex-wrap gap-1"},ft={class:"flex border border-gray-300 rounded text-gray-700 divide-x divide-gray-300 overflow-hidden"},_t={class:"flex p-1"},vt={controls:"",class:"h-10"},wt=["src"],pt={class:"my-auto px-1 text-sm text-gray-500"},xt=s("svg",{class:"w-5 h-5 my-auto",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6 18 18 6M6 6l12 12"})],-1),yt=[xt],bt={key:2,class:"mb-2"},kt={class:"flex flex-wrap gap-1"},Mt={class:"flex border border-gray-300 rounded text-gray-700 divide-x divide-gray-300 overflow-hidden"},Ct={class:"my-auto px-1"},At={class:"mr-1"},Pt={class:"my-auto text-sm text-gray-500"},St=["onClick"],Lt=s("svg",{class:"w-5 h-5 my-auto",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6 18 18 6M6 6l12 12"})],-1),Bt=[Lt],Rt=["readonly"],Tt={class:"flex mt-2"},Ut=s("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",class:"w-5 h-5"},[s("path",{"fill-rule":"evenodd",d:"M5.625 1.5H9a3.75 3.75 0 0 1 3.75 3.75v1.875c0 1.036.84 1.875 1.875 1.875H16.5a3.75 3.75 0 0 1 3.75 3.75v7.875c0 1.035-.84 1.875-1.875 1.875H5.625a1.875 1.875 0 0 1-1.875-1.875V3.375c0-1.036.84-1.875 1.875-1.875ZM12.75 12a.75.75 0 0 0-1.5 0v2.25H9a.75.75 0 0 0 0 1.5h2.25V18a.75.75 0 0 0 1.5 0v-2.25H15a.75.75 0 0 0 0-1.5h-2.25V12Z","clip-rule":"evenodd"}),s("path",{d:"M14.25 5.25a5.23 5.23 0 0 0-1.279-3.434 9.768 9.768 0 0 1 6.963 6.963A5.23 5.23 0 0 0 16.5 7.5h-1.875a.375.375 0 0 1-.375-.375V5.25Z"})],-1),Dt=s("span",{class:"ml-1 hidden sm:inline-block"},"Add Files",-1),It=[Ut,Dt],Ft=s("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",class:"w-5 h-5"},[s("path",{"fill-rule":"evenodd",d:"M1.5 6a2.25 2.25 0 0 1 2.25-2.25h16.5A2.25 2.25 0 0 1 22.5 6v12a2.25 2.25 0 0 1-2.25 2.25H3.75A2.25 2.25 0 0 1 1.5 18V6ZM3 16.06V18c0 .414.336.75.75.75h16.5A.75.75 0 0 0 21 18v-1.94l-2.69-2.689a1.5 1.5 0 0 0-2.12 0l-.88.879.97.97a.75.75 0 1 1-1.06 1.06l-5.16-5.159a1.5 1.5 0 0 0-2.12 0L3 16.061Zm10.125-7.81a1.125 1.125 0 1 1 2.25 0 1.125 1.125 0 0 1-2.25 0Z","clip-rule":"evenodd"})],-1),Nt=s("span",{class:"ml-1 hidden sm:inline-block"},"Add Image",-1),jt=[Ft,Nt],Vt=["disabled"],Zt={key:0},Ht={key:1},Ot={key:1,class:"flex flex-col mx-auto my-auto text-center leading-5"},zt=s("div",{class:"mx-auto mb-1"},[s("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-6 h-6"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193-.34.027-.68.052-1.02.072v3.091l-3-3c-1.354 0-2.694-.055-4.02-.163a2.115 2.115 0 0 1-.825-.242m9.345-8.334a2.126 2.126 0 0 0-.476-.095 48.64 48.64 0 0 0-8.048 0c-1.131.094-1.976 1.057-1.976 2.192v4.286c0 .837.46 1.58 1.155 1.951m9.345-8.334V6.637c0-1.621-1.152-3.026-2.76-3.235A48.455 48.455 0 0 0 11.25 3c-2.115 0-4.198.137-6.24.402-1.608.209-2.76 1.614-2.76 3.235v6.226c0 1.621 1.152 3.026 2.76 3.235.577.075 1.157.14 1.74.194V21l4.155-4.155"})])],-1),$t=s("div",{class:"font-semibold"},"No Active Chat",-1),Et=s("div",null,"Select a Peer to start chatting!",-1),Wt=[zt,$t,Et];function qt(e,t,i,c,a,n){const d=S("AddAudioButton");return i.selectedPeer?(r(),l("div",Ge,[s("div",Je,[s("div",null,[s("div",{onClick:t[0]||(t[0]=(...o)=>n.updateCustomDisplayName&&n.updateCustomDisplayName(...o)),class:"flex cursor-pointer"},[i.selectedPeer.custom_display_name!=null?(r(),l("div",Xe,ss)):u("",!0),s("div",{class:"my-auto font-semibold",title:i.selectedPeer.display_name},h(i.selectedPeer.custom_display_name??i.selectedPeer.display_name),9,ts)]),s("div",os,[N("<"+h(i.selectedPeer.destination_hash)+"> ",1),a.selectedPeerPath?(r(),l("span",{key:0,onClick:t[1]||(t[1]=o=>n.onDestinationPathClick(a.selectedPeerPath)),class:"cursor-pointer"},h(a.selectedPeerPath.hops)+" "+h(a.selectedPeerPath.hops===1?"hop":"hops")+" away",1)):u("",!0)])]),s("div",ns,[s("a",{href:`call.html?destination_hash=${i.selectedPeer.destination_hash}`,target:"_blank",class:"cursor-pointer"},rs,8,is)]),s("div",ls,[s("div",{onClick:t[2]||(t[2]=(...o)=>n.deleteConversation&&n.deleteConversation(...o)),class:"cursor-pointer"},cs)]),s("div",us,[s("div",{onClick:t[3]||(t[3]=(...o)=>n.close&&n.close(...o)),class:"cursor-pointer"},ms)])]),s("div",{onScroll:t[6]||(t[6]=(...o)=>n.onMessagesScroll&&n.onMessagesScroll(...o)),id:"messages",class:"h-full overflow-y-scroll"},[n.selectedPeerChatItems.length>0?(r(),l("div",gs,[(r(!0),l(x,null,b(n.selectedPeerChatItemsReversed,o=>{var m,w,p,L;return r(),l("div",{class:v(["flex flex-col max-w-xl mt-3",{"ml-auto pl-4 md:pl-16 items-end":o.is_outbound,"mr-auto pr-4 md:pr-16 items-start":!o.is_outbound}])},[s("div",{onClick:_=>n.onChatItemClick(o),class:v(["border border-gray-300 rounded-xl shadow overflow-hidden",[o.lxmf_message.state==="failed"?"bg-red-500 text-white":o.is_outbound?"bg-[#3b82f6] text-white":"bg-[#efefef]"]])},[s("div",_s,[o.lxmf_message.content?(r(),l("div",vs,h(o.lxmf_message.content),1)):u("",!0),(m=o.lxmf_message.fields)!=null&&m.image?(r(),l("div",ws,[s("img",{onClick:y(_=>{n.openImage(`data:image/${o.lxmf_message.fields.image.image_type};base64,${o.lxmf_message.fields.image.image_bytes}`)},["stop"]),src:`data:image/${o.lxmf_message.fields.image.image_type};base64,${o.lxmf_message.fields.image.image_bytes}`,class:"w-full rounded-md cursor-pointer"},null,8,ps)])):u("",!0),(w=o.lxmf_message.fields)!=null&&w.audio?(r(),l("div",xs,[a.lxmfMessageAudioAttachmentCache[o.lxmf_message.hash]?(r(),l("audio",ys,[s("source",{src:a.lxmfMessageAudioAttachmentCache[o.lxmf_message.hash],type:"audio/wav"},null,8,bs)])):(r(),l("div",ks,[s("button",{onClick:_=>n.downloadFileFromBase64("audio.bin",o.lxmf_message.fields.audio.audio_bytes),type:"button",class:"my-auto flex border border-gray-300 hover:bg-gray-100 rounded px-2 py-1 text-sm text-gray-700 font-semibold cursor-pointer space-x-2 bg-[#efefef]"},[Cs,s("span",As," Unsupported Audio (mode "+h(o.lxmf_message.fields.audio.audio_mode)+") ",1),Ps],8,Ms)]))])):u("",!0),(p=o.lxmf_message.fields)!=null&&p.file_attachments?(r(),l("div",Ss,[(r(!0),l(x,null,b(((L=o.lxmf_message.fields)==null?void 0:L.file_attachments)??[],_=>(r(),l("a",{onClick:t[4]||(t[4]=y(()=>{},["stop"])),target:"_blank",download:_.file_name,href:`data:application/octet-stream;base64,${_.file_bytes}`,class:"flex border border-gray-300 hover:bg-gray-100 rounded px-2 py-1 text-sm text-gray-700 font-semibold cursor-pointer space-x-2 bg-[#efefef]"},[Bs,s("div",Rs,h(_.file_name),1),Ts],8,Ls))),256))])):u("",!0)]),o.is_actions_expanded?(r(),l("div",Us,[s("button",{onClick:y(_=>n.deleteChatItem(o),["stop"]),type:"button",class:"inline-flex items-center gap-x-1 rounded-md bg-red-500 px-2 py-1 text-xs font-semibold text-white shadow-sm hover:bg-red-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-red-500"}," Delete ",8,Ds)])):u("",!0)],10,fs),o.is_outbound?(r(),l("div",{key:0,class:v(["flex text-right",[o.lxmf_message.state==="failed"?"text-red-500":"text-gray-500"]])},[s("div",Is,[s("div",Fs,[s("span",{onClick:_=>n.showSentMessageInfo(o.lxmf_message),class:"space-x-1 cursor-pointer"},[s("span",null,h(o.lxmf_message.state),1),o.lxmf_message.state==="outbound"&&o.lxmf_message.delivery_attempts>=1?(r(),l("span",js,"(attempt "+h(o.lxmf_message.delivery_attempts+1)+")",1)):u("",!0),o.lxmf_message.state==="sent"&&o.lxmf_message.method==="opportunistic"&&o.lxmf_message.delivery_attempts>=1?(r(),l("span",Vs,"(attempt "+h(o.lxmf_message.delivery_attempts)+")",1)):u("",!0),o.lxmf_message.state==="sent"&&o.lxmf_message.method==="propagated"?(r(),l("span",Zs,"to propagation node")):u("",!0),o.lxmf_message.state==="sending"?(r(),l("span",Hs,h(o.lxmf_message.progress.toFixed(0))+"%",1)):u("",!0)],8,Ns),o.lxmf_message.state==="failed"?(r(),l("a",{key:0,onClick:_=>n.retrySendingMessage(o),class:"ml-1 cursor-pointer underline text-blue-500"},"retry?",8,Os)):u("",!0)]),o.lxmf_message.state==="delivered"?(r(),l("div",zs,Es)):o.lxmf_message.state==="failed"?(r(),l("div",Ws,Ks)):(r(),l("div",Qs,Gs))])],2)):u("",!0),o.is_outbound?u("",!0):(r(),l("div",Js,[s("span",{onClick:_=>n.showReceivedMessageInfo(o.lxmf_message),class:"cursor-pointer"},h(n.formatTimeAgo(o.lxmf_message.created_at)),9,Xs)]))],2)}),256)),k(s("button",{id:"load-previous",onClick:t[5]||(t[5]=(...o)=>n.loadPrevious&&n.loadPrevious(...o)),type:"button",class:"flex space-x-2 mx-auto bg-gray-200 px-3 py-1 hover:bg-gray-300 rounded-full shadow"},tt,512),[[j,!a.isLoadingPrevious&&a.hasMorePrevious]])])):u("",!0)],32),s("div",ot,[s("div",nt,[s("div",null,[a.newMessageImage?(r(),l("div",it,[s("div",at,[a.newMessageImageUrl?(r(),l("img",{key:0,src:a.newMessageImageUrl,class:"w-full h-full"},null,8,rt)):u("",!0),s("div",lt,[s("div",{onClick:t[7]||(t[7]=(...o)=>n.removeImageAttachment&&n.removeImageAttachment(...o)),class:"cursor-pointer"},ct)]),s("div",ut,[s("div",ht,h(n.formatBytes(a.newMessageImage.size)),1)])])])):u("",!0),a.newMessageAudio?(r(),l("div",mt,[s("div",gt,[s("div",ft,[s("div",_t,[s("div",null,[s("audio",vt,[s("source",{src:a.newMessageAudio.audio_wav_url,type:"audio/wav"},null,8,wt)])]),s("div",pt,h(n.formatBytes(a.newMessageAudio.audio_blob.size)),1)]),s("div",{onClick:t[8]||(t[8]=(...o)=>n.removeAudioAttachment&&n.removeAudioAttachment(...o)),class:"flex my-auto text-sm text-gray-500 h-full px-1 hover:bg-gray-200 cursor-pointer"},yt)])])])):u("",!0),a.newMessageFiles.length>0?(r(),l("div",bt,[s("div",kt,[(r(!0),l(x,null,b(a.newMessageFiles,o=>(r(),l("div",Mt,[s("div",Ct,[s("span",At,h(o.name),1),s("span",Pt,h(n.formatBytes(o.size)),1)]),s("div",{onClick:m=>n.removeFileAttachment(o),class:"flex my-auto text-sm text-gray-500 h-full px-1 hover:bg-gray-200 cursor-pointer"},Bt,8,St)]))),256))])])):u("",!0),k(s("textarea",{id:"message-input",readonly:a.isSendingMessage,"onUpdate:modelValue":t[9]||(t[9]=o=>a.newMessageText=o),onKeydown:[t[10]||(t[10]=B(y((...o)=>n.onEnterPressed&&n.onEnterPressed(...o),["exact","prevent"]),["enter","native"])),t[11]||(t[11]=B(y((...o)=>n.onShiftEnterPressed&&n.onShiftEnterPressed(...o),["shift","exact","prevent"]),["enter","native"]))],class:"bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5",rows:"3",placeholder:"Send a message..."},null,40,Rt),[[P,a.newMessageText]]),s("div",Tt,[s("button",{onClick:t[12]||(t[12]=(...o)=>n.addFilesToMessage&&n.addFilesToMessage(...o)),type:"button",class:"my-auto mr-1 inline-flex items-center gap-x-1 rounded-md bg-gray-500 px-2.5 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-gray-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-500"},It),s("button",{onClick:t[13]||(t[13]=(...o)=>n.addImageToMessage&&n.addImageToMessage(...o)),type:"button",class:"my-auto mr-1 inline-flex items-center gap-x-1 rounded-md bg-gray-500 px-2.5 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-gray-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-500"},jt),s("div",null,[M(d,{"is-recording-audio-attachment":a.isRecordingAudioAttachment,onStartRecording:t[14]||(t[14]=o=>n.startRecordingAudioAttachment(o)),onStopRecording:n.stopRecordingAudioAttachment},{default:T(()=>[s("span",null,"Recording: "+h(a.audioAttachmentRecordingDuration),1)]),_:1},8,["is-recording-audio-attachment","onStopRecording"])]),s("button",{onClick:t[15]||(t[15]=(...o)=>n.sendMessage&&n.sendMessage(...o)),disabled:!n.canSendMessage,type:"button",class:v(["ml-auto my-auto inline-flex items-center gap-x-1 rounded-md px-2.5 py-1.5 text-sm font-semibold text-white shadow-sm focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2",[n.canSendMessage?"bg-blue-500 hover:bg-blue-400 focus-visible:outline-blue-500":"bg-gray-400 focus-visible:outline-gray-500 cursor-not-allowed"]])},[a.isSendingMessage?(r(),l("span",Zt,"Sending...")):(r(),l("span",Ht,"Send"))],10,Vt)])])])]),s("input",{ref:"image-input",onChange:t[16]||(t[16]=(...o)=>n.onImageInputChange&&n.onImageInputChange(...o)),type:"file",accept:"image/*",style:{display:"none"}},null,544),s("input",{ref:"file-input",onChange:t[17]||(t[17]=(...o)=>n.onFileInputChange&&n.onFileInputChange(...o)),type:"file",multiple:"",style:{display:"none"}},null,544)])):(r(),l("div",Ot,Wt))}const Kt=A(Ye,[["render",qt]]),Qt={name:"MessagesPage",components:{ConversationViewer:Kt,MessagesSidebar:Ne},data(){return{reloadInterval:null,config:null,peers:{},selectedPeer:null,conversations:[],lxmfDeliveryAnnounces:[]}},beforeUnmount(){clearInterval(this.reloadInterval),C.off("message",this.onWebsocketMessage),R.off("compose-new-message",this.onComposeNewMessage)},mounted(){C.on("message",this.onWebsocketMessage),R.on("compose-new-message",this.onComposeNewMessage),this.getConfig(),this.getConversations(),this.getLxmfDeliveryAnnounces(),this.reloadInterval=setInterval(()=>{this.getConversations()},5e3)},methods:{async onComposeNewMessage(){const e=await g.prompt("Enter LXMF Address");if(!e)return;const t=this.peers[e];if(t){this.onPeerClick(t);return}if(e.length!==32){g.alert("Invalid Address");return}this.onPeerClick({display_name:"Unknown Peer",destination_hash:e})},async getConfig(){try{const e=await window.axios.get("/api/v1/config");this.config=e.data.config}catch(e){console.log(e)}},async onWebsocketMessage(e){const t=JSON.parse(e.data);switch(t.type){case"config":{this.config=t.config;break}case"announce":{t.announce.aspect==="lxmf.delivery"&&this.updatePeerFromAnnounce(t.announce);break}case"lxmf.delivery":{await this.getConversations();break}}},async getLxmfDeliveryAnnounces(){try{const t=(await window.axios.get("/api/v1/announces",{params:{aspect:"lxmf.delivery",limit:500}})).data.announces;for(const i of t)this.updatePeerFromAnnounce(i)}catch(e){console.log(e)}},async getConversations(){try{const e=await window.axios.get("/api/v1/lxmf/conversations");this.conversations=e.data.conversations}catch(e){console.log(e)}},updatePeerFromAnnounce:function(e){this.peers[e.destination_hash]=e},onPeerClick:function(e){this.selectedPeer=e},onConversationClick:function(e){this.onPeerClick(e),this.$refs["conversation-viewer"].markConversationAsRead(e)}},watch:{conversations(){V.unreadConversationsCount=this.conversations.filter(e=>e.is_unread).length}}},Yt={class:"flex flex-col flex-1 overflow-hidden min-w-full sm:min-w-[500px]"};function Gt(e,t,i,c,a,n){var m,w;const d=S("MessagesSidebar"),o=S("ConversationViewer");return r(),l(x,null,[M(d,{conversations:a.conversations,peers:a.peers,"selected-destination-hash":(m=a.selectedPeer)==null?void 0:m.destination_hash,onConversationClick:n.onConversationClick,onPeerClick:n.onPeerClick},null,8,["conversations","peers","selected-destination-hash","onConversationClick","onPeerClick"]),s("div",Yt,[M(o,{ref:"conversation-viewer","my-lxmf-address-hash":(w=a.config)==null?void 0:w.lxmf_address_hash,"selected-peer":a.selectedPeer,conversations:a.conversations,onClose:t[0]||(t[0]=p=>a.selectedPeer=null),onReloadConversations:n.getConversations},null,8,["my-lxmf-address-hash","selected-peer","conversations","onReloadConversations"])])],64)}const Xt=A(Qt,[["render",Gt]]);export{Xt as default};
