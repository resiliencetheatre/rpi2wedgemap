import{_ as S,U as p,o as l,c as d,a as t,n as y,h as C,v as L,b as u,F as b,f as A,t as h,k as F,l as j,e as M,w as U,T as N,W as P,N as V,D as f,m as Z,r as B,d as T,p as k,q as O,s as I,G as D,u as H}from"./app-BYQp0TIl.js";const $={name:"MessagesSidebar",props:{peers:Object,conversations:Array,selectedDestinationHash:String},data(){return{tab:"conversations",conversationsSearchTerm:"",peersSearchTerm:""}},methods:{onConversationClick(e){this.$emit("conversation-click",e)},onPeerClick(e){this.$emit("peer-click",e)},formatTimeAgo:function(e){return p.formatTimeAgo(e)}},computed:{searchedConversations(){return this.conversations.filter(e=>{var n,c;const s=this.conversationsSearchTerm.toLowerCase(),i=e.display_name.toLowerCase().includes(s),r=((c=(n=e.custom_display_name)==null?void 0:n.toLowerCase())==null?void 0:c.includes(s))===!0,a=e.destination_hash.toLowerCase().includes(s);return i||r||a})},peersCount(){return Object.keys(this.peers).length},peersOrderedByLatestAnnounce(){return Object.values(this.peers).sort(function(s,i){const r=new Date(s.updated_at).getTime();return new Date(i.updated_at).getTime()-r})},searchedPeers(){return this.peersOrderedByLatestAnnounce.filter(e=>{var n,c;const s=this.peersSearchTerm.toLowerCase(),i=e.display_name.toLowerCase().includes(s),r=((c=(n=e.custom_display_name)==null?void 0:n.toLowerCase())==null?void 0:c.includes(s))===!0,a=e.destination_hash.toLowerCase().includes(s);return i||r||a})}}},z={class:"flex flex-col w-80 min-w-80"},E={class:"bg-white border-b border-r border-gray-200"},W={class:"-mb-px flex"},q={key:0,class:"flex-1 flex flex-col bg-white border-r overflow-hidden"},Q={key:0,class:"p-1 border-b border-gray-300"},Y=["placeholder"],K={class:"flex h-full overflow-y-auto"},G={key:0,class:"w-full"},J=["onClick"],X=t("div",{class:"my-auto mr-2"},[t("div",{class:"bg-gray-200 text-gray-500 p-2 rounded"},[t("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-6 h-6"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z"})])])],-1),ee={class:"mr-auto"},se={class:"text-gray-500 text-sm"},te={key:0,class:"my-auto ml-2 mr-2"},oe=t("div",{class:"bg-blue-500 rounded-full p-1"},null,-1),ne=[oe],ie={key:1,class:"my-auto ml-2 mr-2"},ae=t("div",{class:"bg-red-500 rounded-full p-1"},null,-1),re=[ae],le={key:1,class:"mx-auto my-auto text-center leading-5"},de={key:0,class:"flex flex-col"},ce=t("div",{class:"mx-auto mb-1"},[t("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"size-6"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M2.25 13.5h3.86a2.25 2.25 0 0 1 2.012 1.244l.256.512a2.25 2.25 0 0 0 2.013 1.244h3.218a2.25 2.25 0 0 0 2.013-1.244l.256-.512a2.25 2.25 0 0 1 2.013-1.244h3.859m-19.5.338V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18v-4.162c0-.224-.034-.447-.1-.661L19.24 5.338a2.25 2.25 0 0 0-2.15-1.588H6.911a2.25 2.25 0 0 0-2.15 1.588L2.35 13.177a2.25 2.25 0 0 0-.1.661Z"})])],-1),ue=t("div",{class:"font-semibold"},"No Conversations",-1),he=t("div",null,"Discover peers on the Announces tab",-1),me=[ce,ue,he],ge={key:1,class:"flex flex-col"},fe=t("div",{class:"mx-auto mb-1"},[t("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-6 h-6"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"})])],-1),_e=t("div",{class:"font-semibold"},"No Search Results",-1),ve=t("div",null,"Your search didn't match any Conversations!",-1),pe=[fe,_e,ve],we={key:1,class:"flex-1 flex flex-col bg-white border-r overflow-hidden"},ye={key:0,class:"p-1 border-b border-gray-300"},xe=["placeholder"],be={class:"flex h-full overflow-y-auto"},ke={key:0,class:"w-full"},Ae=["onClick"],Ce=t("div",{class:"my-auto mr-2"},[t("div",{class:"bg-gray-200 text-gray-500 p-2 rounded"},[t("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-6 h-6"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z"})])])],-1),Me={class:"text-gray-900"},Pe={class:"text-gray-500 text-sm"},Se={key:1,class:"mx-auto my-auto text-center leading-5"},Re={key:0,class:"flex flex-col"},Le=t("div",{class:"mx-auto mb-1"},[t("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-6 h-6"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z"})])],-1),Be=t("div",{class:"font-semibold"},"No Peers Discovered",-1),Te=t("div",null,"Waiting for someone to announce!",-1),Ie=[Le,Be,Te],De={key:1,class:"flex flex-col"},Ue=t("div",{class:"mx-auto mb-1"},[t("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-6 h-6"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"})])],-1),Fe=t("div",{class:"font-semibold"},"No Search Results",-1),je=t("div",null,"Your search didn't match any Peers!",-1),Ne=[Ue,Fe,je];function Ve(e,s,i,r,a,n){return l(),d("div",z,[t("div",E,[t("div",W,[t("div",{onClick:s[0]||(s[0]=c=>a.tab="conversations"),class:y(["w-full border-b-2 py-3 px-1 text-center text-sm font-medium cursor-pointer",[a.tab==="conversations"?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700"]])},"Conversations",2),t("div",{onClick:s[1]||(s[1]=c=>a.tab="announces"),class:y(["w-full border-b-2 py-3 px-1 text-center text-sm font-medium cursor-pointer",[a.tab==="announces"?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700"]])},"Announces",2)])]),a.tab==="conversations"?(l(),d("div",q,[i.conversations.length>0?(l(),d("div",Q,[C(t("input",{"onUpdate:modelValue":s[2]||(s[2]=c=>a.conversationsSearchTerm=c),type:"text",placeholder:`Search ${i.conversations.length} Conversations...`,class:"bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"},null,8,Y),[[L,a.conversationsSearchTerm]])])):u("",!0),t("div",K,[n.searchedConversations.length>0?(l(),d("div",G,[(l(!0),d(b,null,A(n.searchedConversations,c=>(l(),d("div",{onClick:o=>n.onConversationClick(c),class:y(["flex cursor-pointer p-2 border-l-2",[c.destination_hash===i.selectedDestinationHash?"bg-gray-100 border-blue-500":"bg-white border-transparent hover:bg-gray-50 hover:border-gray-200"]])},[X,t("div",ee,[t("div",{class:y(["text-gray-900",{"font-semibold":c.is_unread||c.failed_messages_count>0}])},h(c.custom_display_name??c.display_name),3),t("div",se,h(n.formatTimeAgo(c.updated_at)),1)]),c.is_unread?(l(),d("div",te,ne)):c.failed_messages_count?(l(),d("div",ie,re)):u("",!0)],10,J))),256))])):(l(),d("div",le,[i.conversations.length===0?(l(),d("div",de,me)):u("",!0),a.conversationsSearchTerm!==""&&i.conversations.length>0?(l(),d("div",ge,pe)):u("",!0)]))])])):u("",!0),a.tab==="announces"?(l(),d("div",we,[n.peersCount>0?(l(),d("div",ye,[C(t("input",{"onUpdate:modelValue":s[3]||(s[3]=c=>a.peersSearchTerm=c),type:"text",placeholder:`Search ${n.peersCount} recent announces...`,class:"bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"},null,8,xe),[[L,a.peersSearchTerm]])])):u("",!0),t("div",be,[n.searchedPeers.length>0?(l(),d("div",ke,[(l(!0),d(b,null,A(n.searchedPeers,c=>(l(),d("div",{onClick:o=>n.onPeerClick(c),class:y(["flex cursor-pointer p-2 border-l-2",[c.destination_hash===i.selectedDestinationHash?"bg-gray-100 border-blue-500":"bg-white border-transparent hover:bg-gray-50 hover:border-gray-200"]])},[Ce,t("div",null,[t("div",Me,h(c.custom_display_name??c.display_name),1),t("div",Pe,h(n.formatTimeAgo(c.updated_at)),1)])],10,Ae))),256))])):(l(),d("div",Se,[n.peersCount===0?(l(),d("div",Re,Ie)):u("",!0),a.peersSearchTerm!==""&&n.peersCount>0?(l(),d("div",De,Ne)):u("",!0)]))])])):u("",!0)])}const Ze=S($,[["render",Ve]]);class Oe{constructor(){this.audioChunks=[],this.microphoneMediaStream=null,this.mediaRecorder=null}async start(){try{return this.microphoneMediaStream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.mediaRecorder=new MediaRecorder(this.microphoneMediaStream),this.mediaRecorder.ondataavailable=s=>{this.audioChunks.push(s.data)},this.mediaRecorder.start(),!0}catch{return!1}}async stop(){return new Promise((s,i)=>{try{this.mediaRecorder.onstop=()=>{this.microphoneMediaStream&&this.microphoneMediaStream.getTracks().forEach(a=>a.stop());const r=new Blob(this.audioChunks,{type:this.mediaRecorder.mimeType});s(r)},this.mediaRecorder.stop()}catch(r){i(r)}})}}const He={name:"AddAudioButton",props:{isRecordingAudioAttachment:Boolean},data(){return{isShowingMenu:!1}},methods:{showMenu(){this.isShowingMenu=!0},hideMenu(){this.isShowingMenu=!1},startRecordingAudioAttachment(e){this.isShowingMenu=!1,this.$emit("start-recording",e)},startRecordingCodec2(e){this.startRecordingAudioAttachment({codec:"codec2",mode:e})},startRecordingOpus(){this.startRecordingAudioAttachment({codec:"opus"})},stopRecordingAudioAttachment(){this.isShowingMenu=!1,this.$emit("stop-recording")}}},$e={class:"inline-flex rounded-md shadow-sm"},ze=t("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",class:"size-5"},[t("path",{d:"M7 4a3 3 0 0 1 6 0v6a3 3 0 1 1-6 0V4Z"}),t("path",{d:"M5.5 9.643a.75.75 0 0 0-1.5 0V10c0 3.06 2.29 5.585 5.25 5.954V17.5h-1.5a.75.75 0 0 0 0 1.5h4.5a.75.75 0 0 0 0-1.5h-1.5v-1.546A6.001 6.001 0 0 0 16 10v-.357a.75.75 0 0 0-1.5 0V10a4.5 4.5 0 0 1-9 0v-.357Z"})],-1),Ee={class:"ml-1"},We=t("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",class:"size-5"},[t("path",{d:"M7 4a3 3 0 0 1 6 0v6a3 3 0 1 1-6 0V4Z"}),t("path",{d:"M5.5 9.643a.75.75 0 0 0-1.5 0V10c0 3.06 2.29 5.585 5.25 5.954V17.5h-1.5a.75.75 0 0 0 0 1.5h4.5a.75.75 0 0 0 0-1.5h-1.5v-1.546A6.001 6.001 0 0 0 16 10v-.357a.75.75 0 0 0-1.5 0V10a4.5 4.5 0 0 1-9 0v-.357Z"})],-1),qe=t("span",{class:"ml-1 hidden sm:inline-block"},"Add Voice",-1),Qe=[We,qe],Ye={class:"relative block"},Ke={key:0,class:"absolute bottom-0 -ml-11 sm:right-0 sm:ml-0 z-10 mb-10 rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none"},Ge={class:"py-1"};function Je(e,s,i,r,a,n){const c=F("click-outside");return l(),d("div",$e,[i.isRecordingAudioAttachment?(l(),d("button",{key:0,onClick:s[0]||(s[0]=(...o)=>n.stopRecordingAudioAttachment&&n.stopRecordingAudioAttachment(...o)),type:"button",class:"my-auto mr-1 inline-flex items-center gap-x-1 rounded-md bg-red-500 px-2.5 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-red-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-red-500"},[ze,t("span",Ee,[j(e.$slots,"default")])])):(l(),d("button",{key:1,onClick:s[1]||(s[1]=(...o)=>n.showMenu&&n.showMenu(...o)),type:"button",class:"my-auto mr-1 inline-flex items-center gap-x-1 rounded-md bg-gray-500 px-2.5 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-gray-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-500"},Qe)),t("div",Ye,[M(N,{"enter-active-class":"transition ease-out duration-100","enter-from-class":"transform opacity-0 scale-95","enter-to-class":"transform opacity-100 scale-100","leave-active-class":"transition ease-in duration-75","leave-from-class":"transform opacity-100 scale-100","leave-to-class":"transform opacity-0 scale-95"},{default:U(()=>[a.isShowingMenu?C((l(),d("div",Ke,[t("div",Ge,[t("button",{onClick:s[2]||(s[2]=o=>n.startRecordingCodec2("1200")),type:"button",class:"w-full block text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 whitespace-nowrap"},"Low Quality - Codec2 (1200)"),t("button",{onClick:s[3]||(s[3]=o=>n.startRecordingCodec2("3200")),type:"button",class:"w-full block text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 whitespace-nowrap"},"Medium Quality - Codec2 (3200)"),t("button",{onClick:s[4]||(s[4]=o=>n.startRecordingOpus()),type:"button",class:"w-full block text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 whitespace-nowrap"},"High Quality - OPUS")])])),[[c,n.hideMenu]]):u("",!0)]),_:1})])])}const Xe=S(He,[["render",Je]]),es={name:"ConversationViewer",components:{AddAudioButton:Xe},props:{myLxmfAddressHash:String,selectedPeer:Object,conversations:Array},data(){return{selectedPeerPath:null,selectedPeerLxmfStampInfo:null,lxmfMessagesRequestSequence:0,chatItems:[],isLoadingPrevious:!1,hasMorePrevious:!0,newMessageText:"",newMessageImage:null,newMessageImageUrl:null,newMessageAudio:null,newMessageFiles:[],isSendingMessage:!1,autoScrollOnNewMessage:!0,isRecordingAudioAttachment:!1,audioAttachmentMicrophoneRecorder:null,audioAttachmentMicrophoneRecorderCodec:null,audioAttachmentRecordingStartedAt:null,audioAttachmentRecordingDuration:null,audioAttachmentRecordingTimer:null,lxmfMessageAudioAttachmentCache:{},lxmfAudioModeToCodec2ModeMap:{1:"450PWB",2:"450",3:"700C",4:"1200",5:"1300",6:"1400",7:"1600",8:"2400",9:"3200"}}},beforeUnmount(){P.off("message",this.onWebsocketMessage)},mounted(){P.on("message",this.onWebsocketMessage)},methods:{close(){this.$emit("close")},onMessagesScroll(e){const s=e.target,i=s.scrollTop===s.scrollHeight-s.offsetHeight;this.autoScrollOnNewMessage=i,s.scrollTop<=500&&this.loadPrevious()},async initialLoad(){this.chatItems=[],this.hasMorePrevious=!0,this.selectedPeer&&(this.getPeerPath(),this.getPeerLxmfStampInfo(),await this.loadPrevious(),this.scrollMessagesToBottom())},async loadPrevious(){if(!this.isLoadingPrevious){this.isLoadingPrevious=!0;try{const e=++this.lxmfMessagesRequestSequence,s=30,i=await window.axios.get(`/api/v1/lxmf-messages/conversation/${this.selectedPeer.destination_hash}`,{params:{count:s,order:"desc",after_id:this.oldestMessageId}});if(e!==this.lxmfMessagesRequestSequence){console.log("ignoring response for previous lxmf messages request");return}const r=[],a=i.data.lxmf_messages;for(const n of a)r.push({type:"lxmf_message",is_outbound:this.myLxmfAddressHash===n.source_hash,lxmf_message:n});for(const n of r)this.chatItems.unshift(n);r.length<s&&(this.hasMorePrevious=!1)}catch{}finally{this.isLoadingPrevious=!1}}},async onWebsocketMessage(e){var i;const s=JSON.parse(e.data);switch(s.type){case"announce":{s.announce.destination_hash===((i=this.selectedPeer)==null?void 0:i.destination_hash)&&await this.getPeerLxmfStampInfo();break}case"lxmf.delivery":{this.onLxmfMessageReceived(s.lxmf_message),await this.getPeerPath();break}case"lxmf_message_created":{this.onLxmfMessageCreated(s.lxmf_message),await this.getPeerPath();break}case"lxmf_message_state_updated":{this.onLxmfMessageUpdated(s.lxmf_message);break}case"lxmf_message_deleted":{this.onLxmfMessageDeleted(s.hash);break}}},onLxmfMessageReceived(e){var s;if(this.chatItems.push({type:"lxmf_message",lxmf_message:e}),e.source_hash===((s=this.selectedPeer)==null?void 0:s.destination_hash)){const i=this.findConversation(this.selectedPeer.destination_hash);i&&this.markConversationAsRead(i)}document.hasFocus()||V.showNewMessageNotification(),this.autoScrollOnNewMessage&&this.scrollMessagesToBottom()},onLxmfMessageCreated(e){this.isLxmfMessageInUi(e.hash)||this.chatItems.push({type:"lxmf_message",lxmf_message:e,is_outbound:!0})},onLxmfMessageUpdated(e){const s=e.hash,i=this.chatItems.findIndex(r=>{var a;return((a=r.lxmf_message)==null?void 0:a.hash)===s});if(i===-1){console.log("did not find existing chat item index for lxmf message hash: "+e.hash);return}this.chatItems[i].lxmf_message=e},onLxmfMessageDeleted(e){e&&(this.chatItems=this.chatItems.filter(s=>{var i;return((i=s.lxmf_message)==null?void 0:i.hash)!==e}))},async getPeerPath(){if(this.selectedPeerPath=null,this.selectedPeer)try{const e=await window.axios.get(`/api/v1/destination/${this.selectedPeer.destination_hash}/path`);this.selectedPeerPath=e.data.path}catch(e){console.log(e)}},async getPeerLxmfStampInfo(){if(this.selectedPeerLxmfStampInfo=null,this.selectedPeer)try{const e=await window.axios.get(`/api/v1/destination/${this.selectedPeer.destination_hash}/lxmf-stamp-info`);this.selectedPeerLxmfStampInfo=e.data.lxmf_stamp_info}catch(e){console.log(e)}},onDestinationPathClick(e){f.alert(`${e.hops} ${e.hops===1?"hop":"hops"} away via ${e.next_hop_interface}`)},onStampInfoClick(e){const s=e.stamp_cost,i=e.outbound_ticket_expiry;var r="";s>=24?r="several hours":s>=20?r="more than an hour":s>=18?r="~5 minutes":s>=17?r="a few minutes":s>=16?r="~1 minute":s>=13?r="~30 seconds":s>=9?r="~10 seconds":s>=1?r="a few seconds":r="0 seconds",i!=null&&(r=`instant (ticket expires ${Z(i*1e3).fromNow()})`),f.alert(`This peer has enabled stamp security.

Your device must have a ticket, or solve an automated proof of work task each time you send them a message.

Time per message: ${r}`)},scrollMessagesToBottom:function(){this.$nextTick(()=>{setTimeout(()=>{const e=document.getElementById("messages");e&&(e.scrollTop=e.scrollHeight)},0)})},isLxmfMessageInUi:function(e){return this.chatItems.findIndex(s=>{var i;return((i=s.lxmf_message)==null?void 0:i.hash)===e})!==-1},async getCustomDisplayName(){if(this.selectedPeer)try{const e=await window.axios.get(`/api/v1/destination/${this.selectedPeer.destination_hash}/custom-display-name`);this.selectedPeer.custom_display_name=e.data.custom_display_name}catch(e){console.log(e)}},async updateCustomDisplayName(){if(!this.selectedPeer)return;const e=await f.prompt("Enter a custom display name");if(e!=null)try{await axios.post(`/api/v1/destination/${this.selectedPeer.destination_hash}/custom-display-name/update`,{display_name:e}),await this.getCustomDisplayName(),this.$emit("reload-conversations")}catch(s){console.log(s),f.alert("Failed to update display name")}},async deleteConversation(){if(this.selectedPeer&&confirm("Are you sure you want to delete all messages from this conversation? This can not be undone!")){try{await window.axios.delete(`/api/v1/lxmf-messages/conversation/${this.selectedPeer.destination_hash}`)}catch(e){f.alert("failed to delete conversation"),console.log(e)}await this.initialLoad(),this.$emit("reload-conversations")}},onChatItemClick:function(e){e.is_actions_expanded?e.is_actions_expanded=!1:e.is_actions_expanded=!0},openImage:async function(e){const s=await(await fetch(e)).blob(),i=window.URL.createObjectURL(s);window.open(i)},downloadFileFromBase64:async function(e,s){const i=atob(s),r=new Array(i.length);for(let m=0;m<i.length;m++)r[m]=i.charCodeAt(m);const a=new Uint8Array(r),n=new Blob([a]),c=URL.createObjectURL(n),o=document.createElement("a");o.href=c,o.download=e,o.style.display="none",document.body.append(o),o.click(),o.remove(),setTimeout(()=>URL.revokeObjectURL(c),1e4)},async processAudioForSelectedPeerChatItems(){var e,s;for(const i of this.selectedPeerChatItems){if(!((s=(e=i.lxmf_message)==null?void 0:e.fields)!=null&&s.audio)||this.lxmfMessageAudioAttachmentCache[i.lxmf_message.hash])continue;const r=await this.decodeLxmfAudioFieldToBlobUrl(i.lxmf_message.fields.audio);r&&(this.lxmfMessageAudioAttachmentCache[i.lxmf_message.hash]=r)}},async decodeLxmfAudioFieldToBlobUrl(e){try{const s=e.audio_mode,i=e.audio_bytes;if(s===16)return this.decodeOpusAudioToBlobUrl(e.audio_bytes);const r=this.lxmfAudioModeToCodec2ModeMap[s];if(!r)return console.log("unsupported audio mode: "+s),null;const a=this.base64ToArrayBuffer(i),n=await Codec2Lib.runDecode(r,new Uint8Array(a)),c=await Codec2Lib.rawToWav(n),o=new Blob([c],{type:"audio/wav"});return URL.createObjectURL(o)}catch(s){return console.log(s),null}},async decodeOpusAudioToBlobUrl(e){try{const s=this.base64ToArrayBuffer(e),i=new Blob([s],{type:"audio/opus"});return URL.createObjectURL(i)}catch(s){return console.log(s),null}},base64ToArrayBuffer:function(e){return Uint8Array.from(atob(e),s=>s.charCodeAt(0))},async deleteChatItem(e,s=!0){try{if(s&&!confirm("Are you sure you want to delete this message? This can not be undone!")||e.type!=="lxmf_message")return;await window.axios.delete(`/api/v1/lxmf-messages/${e.lxmf_message.hash}`),this.chatItems=this.chatItems.filter(i=>{var r;return((r=i.lxmf_message)==null?void 0:r.hash)!==e.lxmf_message.hash})}catch{}},async sendMessage(){var r,a;if(this.canSendMessage&&this.selectedPeer){this.isSendingMessage=!0;try{const n={};var e=0;if(this.newMessageFiles.length>0){const _=[];for(const v of this.newMessageFiles)e+=v.size,_.push({file_name:v.name,file_bytes:p.arrayBufferToBase64(await v.arrayBuffer())});n.file_attachments=_}var s=0;this.newMessageImage&&(s=this.newMessageImage.size,n.image={image_type:this.newMessageImage.type.replace("image/",""),image_bytes:p.arrayBufferToBase64(await this.newMessageImage.arrayBuffer())});var i=0;this.newMessageAudio&&(i=this.newMessageAudio.size,n.audio={audio_mode:this.newMessageAudio.audio_mode,audio_bytes:p.arrayBufferToBase64(await this.newMessageAudio.audio_blob.arrayBuffer())});const o=this.newMessageText.length+e+s+i;if(o>1e3*900&&!confirm(`Your message exceeds 900KB (It's ${this.formatBytes(o)}). It may be rejected by the recipient unless they have increased their delivery limit. Do you want to try sending anyway?`))return;const m=await window.axios.post("/api/v1/lxmf-messages/send",{lxmf_message:{destination_hash:this.selectedPeer.destination_hash,content:this.newMessageText,fields:n}});this.isLxmfMessageInUi(m.data.lxmf_message.hash)||this.chatItems.push({type:"lxmf_message",lxmf_message:m.data.lxmf_message,is_outbound:!0}),this.scrollMessagesToBottom(),this.newMessageText="",this.newMessageImage=null,this.newMessageImageUrl=null,this.newMessageAudio=null,this.newMessageFiles=[],this.clearImageInput(),this.clearFileInput()}catch(n){const c=((a=(r=n.response)==null?void 0:r.data)==null?void 0:a.message)??"failed to send message";f.alert(c),console.log(n)}finally{this.isSendingMessage=!1}}},async retrySendingMessage(e){var s,i;await this.deleteChatItem(e,!1);try{const r=await window.axios.post("/api/v1/lxmf-messages/send",{lxmf_message:{destination_hash:e.lxmf_message.destination_hash,content:e.lxmf_message.content,fields:e.lxmf_message.fields}});this.isLxmfMessageInUi(r.data.lxmf_message.hash)||this.chatItems.push({type:"lxmf_message",lxmf_message:r.data.lxmf_message,is_outbound:!0}),this.scrollMessagesToBottom()}catch(r){const a=((i=(s=r.response)==null?void 0:s.data)==null?void 0:i.message)??"failed to send message";f.alert(a),console.log(r)}},formatTimeAgo:function(e){return p.formatTimeAgo(e)},formatBytes:function(e){return p.formatBytes(e)},onFileInputChange:function(e){for(const s of e.target.files)this.newMessageFiles.push(s)},clearFileInput:function(){this.$refs["file-input"].value=null},removeImageAttachment:function(){this.newMessageImage=null,this.newMessageImageUrl=null},onImageInputChange:function(e){if(e.target.files.length>0){this.newMessageImage=e.target.files[0];const s=new FileReader;s.onload=i=>{this.newMessageImageUrl=i.target.result},s.readAsDataURL(this.newMessageImage),this.clearImageInput()}},clearImageInput:function(){this.$refs["image-input"].value=null},async startRecordingAudioAttachment(e){if(!this.isRecordingAudioAttachment&&!(this.newMessageAudio&&!confirm("An audio recording is already attached. A new recording will replace it. Do you want to continue?")))switch(e.codec){case"codec2":{this.audioAttachmentMicrophoneRecorderCodec="codec2",this.audioAttachmentMicrophoneRecorder=new Codec2MicrophoneRecorder,this.audioAttachmentMicrophoneRecorder.codec2Mode=e.mode,this.audioAttachmentRecordingStartedAt=Date.now(),this.isRecordingAudioAttachment=await this.audioAttachmentMicrophoneRecorder.start(),this.audioAttachmentRecordingDuration=p.formatMinutesSeconds(0),this.audioAttachmentRecordingTimer=setInterval(()=>{const i=(Date.now()-this.audioAttachmentRecordingStartedAt)/1e3;this.audioAttachmentRecordingDuration=p.formatMinutesSeconds(i)},1e3),this.isRecordingAudioAttachment||f.alert("failed to start recording");break}case"opus":{this.audioAttachmentMicrophoneRecorderCodec="opus",this.audioAttachmentMicrophoneRecorder=new Oe,this.audioAttachmentRecordingStartedAt=Date.now(),this.isRecordingAudioAttachment=await this.audioAttachmentMicrophoneRecorder.start(),this.audioAttachmentRecordingDuration=p.formatMinutesSeconds(0),this.audioAttachmentRecordingTimer=setInterval(()=>{const i=(Date.now()-this.audioAttachmentRecordingStartedAt)/1e3;this.audioAttachmentRecordingDuration=p.formatMinutesSeconds(i)},1e3),this.isRecordingAudioAttachment||f.alert("failed to start recording");break}default:{f.alert(`Unhandled microphone recorder codec: ${e.codec}`);break}}},async stopRecordingAudioAttachment(){if(clearInterval(this.audioAttachmentRecordingTimer),!this.isRecordingAudioAttachment)return;this.isRecordingAudioAttachment=!1;const e=await this.audioAttachmentMicrophoneRecorder.stop();switch(this.audioAttachmentMicrophoneRecorderCodec){case"codec2":{if(e.length===0)return;const i=this.audioAttachmentMicrophoneRecorder.codec2Mode,r=await Codec2Lib.runDecode(i,new Uint8Array(e)),a=await Codec2Lib.rawToWav(r),n=new Blob([a],{type:"audio/wav"});var s=null;switch(i){case"1200":{s=4;break}case"3200":{s=9;break}default:{f.alert(`Unhandled microphone recorder codec2Mode: ${i}`);return}}this.newMessageAudio={audio_mode:s,audio_blob:new Blob([e]),audio_preview_url:URL.createObjectURL(n)};break}case"opus":{if(e.size===0)return;this.newMessageAudio={audio_mode:16,audio_blob:e,audio_preview_url:URL.createObjectURL(e)};break}}},removeAudioAttachment:function(){confirm("Are you sure you want to remove this audio attachment?")&&(this.newMessageAudio=null)},removeFileAttachment:function(e){this.newMessageFiles=this.newMessageFiles.filter(s=>s!==e)},addNewLine:function(){this.newMessageText+=`
`},onEnterPressed:function(){if(this.isMobile){this.addNewLine();return}this.sendMessage()},onShiftEnterPressed:function(){this.addNewLine()},addFilesToMessage:function(){this.$refs["file-input"].click()},addImageToMessage:function(){this.$refs["image-input"].click()},findConversation:function(e){return this.conversations.find(s=>s.destination_hash===e)},async markConversationAsRead(e){e.is_unread=!1;try{await window.axios.get(`/api/v1/lxmf/conversations/${e.destination_hash}/mark-as-read`)}catch(s){console.log(s)}this.$emit("reload-conversations")},showSentMessageInfo:function(e){var r,a,n,c,o,m,_,v,x,g;const s=[`Created: ${p.convertUnixMillisToLocalDateTimeString(e.timestamp*1e3)}`,`Method: ${e.method??"unknown"}`];if((a=(r=e.fields)==null?void 0:r.audio)!=null&&a.audio_bytes){const w=atob((c=(n=e.fields)==null?void 0:n.audio)==null?void 0:c.audio_bytes).length;s.push(`Audio Attachment: ${this.formatBytes(w)}`)}if((m=(o=e.fields)==null?void 0:o.image)!=null&&m.image_bytes){const w=atob((v=(_=e.fields)==null?void 0:_.image)==null?void 0:v.image_bytes).length;s.push(`Image Attachment: ${this.formatBytes(w)}`)}if((x=e.fields)!=null&&x.file_attachments){var i=0;for(const w of(g=e.fields)==null?void 0:g.file_attachments){const R=atob(w.file_bytes).length;i+=R}s.push(`File Attachments: ${this.formatBytes(i)}`)}f.alert(s.join(`
`))},showReceivedMessageInfo:function(e){var r,a,n,c,o,m,_,v,x,g;const s=[`Sent: ${p.convertUnixMillisToLocalDateTimeString(e.timestamp*1e3)}`,`Received: ${p.convertDateTimeToLocalDateTimeString(new Date(e.created_at))}`,`Method: ${e.method??"unknown"}`];if((a=(r=e.fields)==null?void 0:r.audio)!=null&&a.audio_bytes){const w=atob((c=(n=e.fields)==null?void 0:n.audio)==null?void 0:c.audio_bytes).length;s.push(`Audio Attachment: ${this.formatBytes(w)}`)}if((m=(o=e.fields)==null?void 0:o.image)!=null&&m.image_bytes){const w=atob((v=(_=e.fields)==null?void 0:_.image)==null?void 0:v.image_bytes).length;s.push(`Image Attachment: ${this.formatBytes(w)}`)}if((x=e.fields)!=null&&x.file_attachments){var i=0;for(const w of(g=e.fields)==null?void 0:g.file_attachments){const R=atob(w.file_bytes).length;i+=R}s.push(`File Attachments: ${this.formatBytes(i)}`)}e.quality!=null&&s.push(`Signal Quality: ${e.quality}%`),e.rssi!=null&&s.push(`RSSI: ${e.rssi}dBm`),e.snr!=null&&s.push(`SNR: ${e.snr}dB`),f.alert(s.join(`
`))}},computed:{isMobile(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)},canSendMessage(){const e=this.newMessageText.trim();return!(e==null||e===""||this.isSendingMessage)},selectedPeerChatItems(){return this.selectedPeer?this.chatItems.filter(e=>{if(e.type==="lxmf_message"){const s=e.lxmf_message.source_hash===this.selectedPeer.destination_hash,i=e.lxmf_message.destination_hash===this.selectedPeer.destination_hash;return s||i}return!1}):[]},selectedPeerChatItemsReversed(){return this.selectedPeerChatItems.map(e=>e).reverse()},oldestMessageId(){return this.selectedPeerChatItems.length>0?this.selectedPeerChatItems[0].lxmf_message.id:null}},watch:{selectedPeer(){this.initialLoad()},async selectedPeerChatItems(){await this.processAudioForSelectedPeerChatItems()}}},ss={key:0,class:"flex flex-col h-full bg-white overflow-hidden sm:m-2 sm:border sm:rounded-xl sm:shadow"},ts={class:"flex p-2 border-b border-gray-300"},os={key:0,class:"my-auto mr-1",title:"Custom Display Name"},ns=t("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"size-4"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M9.568 3H5.25A2.25 2.25 0 0 0 3 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 0 0 5.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 0 0 9.568 3Z"}),t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6 6h.008v.008H6V6Z"})],-1),is=[ns],as=["title"],rs={class:"text-sm"},ls={key:1},ds={class:"ml-auto my-auto mr-2"},cs=["href"],us=t("div",{class:"flex text-gray-700 bg-gray-100 hover:bg-gray-200 p-2 rounded-full"},[t("div",null,[t("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-5 h-5"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 0 0 2.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 0 1-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 0 0-1.091-.852H4.5A2.25 2.25 0 0 0 2.25 4.5v2.25Z"})])])],-1),hs=[us],ms={class:"my-auto mr-2"},gs=t("div",{class:"flex text-gray-700 bg-gray-100 hover:bg-gray-200 p-2 rounded-full"},[t("div",null,[t("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-5 h-5"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"})])])],-1),fs=[gs],_s={class:"my-auto mr-2"},vs=t("div",{class:"flex text-gray-700 bg-gray-100 hover:bg-gray-200 p-2 rounded-full"},[t("div",null,[t("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",class:"w-5 h-5"},[t("path",{d:"M6.28 5.22a.75.75 0 0 0-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 1 0 1.06 1.06L10 11.06l3.72 3.72a.75.75 0 1 0 1.06-1.06L11.06 10l3.72-3.72a.75.75 0 0 0-1.06-1.06L10 8.94 6.28 5.22Z"})])])],-1),ps=[vs],ws={key:0,class:"flex flex-col flex-col-reverse p-3"},ys=["onClick"],xs={class:"w-full space-y-0.5 px-2.5 py-1"},bs={key:0,style:{"white-space":"pre-wrap","word-break":"break-word","font-family":"inherit"}},ks={key:1},As=["onClick","src"],Cs={key:2,class:"pb-1"},Ms={key:0,controls:"",class:"shadow rounded-full",style:{height:"54px"}},Ps=["src"],Ss={key:1,style:{"min-height":"54px"},class:"flex"},Rs=["onClick"],Ls=t("span",{class:"my-auto"},[t("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"size-6"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m9 9 10.5-3m0 6.553v3.75a2.25 2.25 0 0 1-1.632 2.163l-1.32.377a1.803 1.803 0 1 1-.99-3.467l2.31-.66a2.25 2.25 0 0 0 1.632-2.163Zm0 0V2.25L9 5.25v10.303m0 0v3.75a2.25 2.25 0 0 1-1.632 2.163l-1.32.377a1.803 1.803 0 0 1-.99-3.467l2.31-.66A2.25 2.25 0 0 0 9 15.553Z"})])],-1),Bs={class:"my-auto w-full"},Ts=t("span",{class:"my-auto"},[t("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-6 h-6"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3"})])],-1),Is={key:3,class:"space-y-1"},Ds=["download","href"],Us=t("div",{class:"my-auto"},[t("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-6 h-6"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m18.375 12.739-7.693 7.693a4.5 4.5 0 0 1-6.364-6.364l10.94-10.94A3 3 0 1 1 19.5 7.372L8.552 18.32m.009-.01-.01.01m5.699-9.941-7.81 7.81a1.5 1.5 0 0 0 2.112 2.13"})])],-1),Fs={class:"my-auto w-full"},js=t("div",{class:"my-auto"},[t("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-6 h-6"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3"})])],-1),Ns={key:0,class:"border-t p-1 bg-[#efefef] text-white"},Vs=["onClick"],Zs={class:"flex ml-auto space-x-1"},Os={class:"my-auto"},Hs=["onClick"],$s={key:0},zs={key:1},Es={key:2},Ws={key:3},qs=["onClick"],Qs={key:0,class:"my-auto"},Ys=t("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",class:"w-5 h-5"},[t("path",{"fill-rule":"evenodd",d:"M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 1 0-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 0 0-1.06 1.06l2.25 2.25a.75.75 0 0 0 1.14-.094l3.75-5.25Z","clip-rule":"evenodd"})],-1),Ks=[Ys],Gs={key:1,class:"my-auto"},Js=t("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",class:"w-5 h-5"},[t("path",{"fill-rule":"evenodd",d:"M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12ZM12 8.25a.75.75 0 0 1 .75.75v3.75a.75.75 0 0 1-1.5 0V9a.75.75 0 0 1 .75-.75Zm0 8.25a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z","clip-rule":"evenodd"})],-1),Xs=[Js],et={key:2,class:"my-auto"},st=t("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-5 h-5"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"})],-1),tt=[st],ot={key:1,class:"text-xs text-gray-500 mt-0.5 flex flex-col"},nt=["onClick"],it=t("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"size-6"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m15 11.25-3-3m0 0-3 3m3-3v7.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"})],-1),at=t("span",null,"Load Previous",-1),rt=[it,at],lt={class:"w-full border-gray-300 border-t p-2"},dt={class:"mx-auto"},ct={key:0,class:"mb-2"},ut={class:"w-32 h-32 rounded shadow border relative overflow-hidden"},ht=["src"],mt={class:"absolute top-0 right-0 p-1"},gt=t("div",{class:"flex text-gray-700 bg-gray-100 hover:bg-gray-200 p-1 rounded-full"},[t("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",class:"w-4 h-4"},[t("path",{d:"M6.28 5.22a.75.75 0 0 0-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 1 0 1.06 1.06L10 11.06l3.72 3.72a.75.75 0 1 0 1.06-1.06L11.06 10l3.72-3.72a.75.75 0 0 0-1.06-1.06L10 8.94 6.28 5.22Z"})])],-1),ft=[gt],_t={class:"absolute bottom-0 left-0 p-1"},vt={class:"bg-gray-100 rounded border text-sm px-1"},pt={key:1,class:"mb-2"},wt={class:"flex flex-wrap gap-1"},yt={class:"flex border border-gray-300 rounded text-gray-700 divide-x divide-gray-300 overflow-hidden"},xt={class:"flex p-1"},bt={controls:"",class:"h-10"},kt=["src"],At={class:"my-auto px-1 text-sm text-gray-500"},Ct=t("svg",{class:"w-5 h-5 my-auto",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6 18 18 6M6 6l12 12"})],-1),Mt=[Ct],Pt={key:2,class:"mb-2"},St={class:"flex flex-wrap gap-1"},Rt={class:"flex border border-gray-300 rounded text-gray-700 divide-x divide-gray-300 overflow-hidden"},Lt={class:"my-auto px-1"},Bt={class:"mr-1"},Tt={class:"my-auto text-sm text-gray-500"},It=["onClick"],Dt=t("svg",{class:"w-5 h-5 my-auto",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6 18 18 6M6 6l12 12"})],-1),Ut=[Dt],Ft=["readonly"],jt={class:"flex mt-2"},Nt=t("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",class:"w-5 h-5"},[t("path",{"fill-rule":"evenodd",d:"M5.625 1.5H9a3.75 3.75 0 0 1 3.75 3.75v1.875c0 1.036.84 1.875 1.875 1.875H16.5a3.75 3.75 0 0 1 3.75 3.75v7.875c0 1.035-.84 1.875-1.875 1.875H5.625a1.875 1.875 0 0 1-1.875-1.875V3.375c0-1.036.84-1.875 1.875-1.875ZM12.75 12a.75.75 0 0 0-1.5 0v2.25H9a.75.75 0 0 0 0 1.5h2.25V18a.75.75 0 0 0 1.5 0v-2.25H15a.75.75 0 0 0 0-1.5h-2.25V12Z","clip-rule":"evenodd"}),t("path",{d:"M14.25 5.25a5.23 5.23 0 0 0-1.279-3.434 9.768 9.768 0 0 1 6.963 6.963A5.23 5.23 0 0 0 16.5 7.5h-1.875a.375.375 0 0 1-.375-.375V5.25Z"})],-1),Vt=t("span",{class:"ml-1 hidden sm:inline-block"},"Add Files",-1),Zt=[Nt,Vt],Ot=t("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",class:"w-5 h-5"},[t("path",{"fill-rule":"evenodd",d:"M1.5 6a2.25 2.25 0 0 1 2.25-2.25h16.5A2.25 2.25 0 0 1 22.5 6v12a2.25 2.25 0 0 1-2.25 2.25H3.75A2.25 2.25 0 0 1 1.5 18V6ZM3 16.06V18c0 .414.336.75.75.75h16.5A.75.75 0 0 0 21 18v-1.94l-2.69-2.689a1.5 1.5 0 0 0-2.12 0l-.88.879.97.97a.75.75 0 1 1-1.06 1.06l-5.16-5.159a1.5 1.5 0 0 0-2.12 0L3 16.061Zm10.125-7.81a1.125 1.125 0 1 1 2.25 0 1.125 1.125 0 0 1-2.25 0Z","clip-rule":"evenodd"})],-1),Ht=t("span",{class:"ml-1 hidden sm:inline-block"},"Add Image",-1),$t=[Ot,Ht],zt=["disabled"],Et={key:0},Wt={key:1},qt={key:1,class:"flex flex-col mx-auto my-auto text-center leading-5"},Qt=t("div",{class:"mx-auto mb-1"},[t("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-6 h-6"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193-.34.027-.68.052-1.02.072v3.091l-3-3c-1.354 0-2.694-.055-4.02-.163a2.115 2.115 0 0 1-.825-.242m9.345-8.334a2.126 2.126 0 0 0-.476-.095 48.64 48.64 0 0 0-8.048 0c-1.131.094-1.976 1.057-1.976 2.192v4.286c0 .837.46 1.58 1.155 1.951m9.345-8.334V6.637c0-1.621-1.152-3.026-2.76-3.235A48.455 48.455 0 0 0 11.25 3c-2.115 0-4.198.137-6.24.402-1.608.209-2.76 1.614-2.76 3.235v6.226c0 1.621 1.152 3.026 2.76 3.235.577.075 1.157.14 1.74.194V21l4.155-4.155"})])],-1),Yt=t("div",{class:"font-semibold"},"No Active Chat",-1),Kt=t("div",null,"Select a Peer to start chatting!",-1),Gt=[Qt,Yt,Kt];function Jt(e,s,i,r,a,n){const c=B("AddAudioButton");return i.selectedPeer?(l(),d("div",ss,[t("div",ts,[t("div",null,[t("div",{onClick:s[0]||(s[0]=(...o)=>n.updateCustomDisplayName&&n.updateCustomDisplayName(...o)),class:"flex cursor-pointer"},[i.selectedPeer.custom_display_name!=null?(l(),d("div",os,is)):u("",!0),t("div",{class:"my-auto font-semibold",title:i.selectedPeer.display_name},h(i.selectedPeer.custom_display_name??i.selectedPeer.display_name),9,as)]),t("div",rs,[T(" <"+h(i.selectedPeer.destination_hash)+"> ",1),a.selectedPeerPath?(l(),d("span",{key:0,onClick:s[1]||(s[1]=o=>n.onDestinationPathClick(a.selectedPeerPath)),class:"cursor-pointer"},h(a.selectedPeerPath.hops)+" "+h(a.selectedPeerPath.hops===1?"hop":"hops")+" away",1)):u("",!0),a.selectedPeerLxmfStampInfo&&a.selectedPeerLxmfStampInfo.stamp_cost?(l(),d("span",ls,[T(" • "),t("span",{onClick:s[2]||(s[2]=o=>n.onStampInfoClick(a.selectedPeerLxmfStampInfo)),class:"cursor-pointer"},"Stamp Cost "+h(a.selectedPeerLxmfStampInfo.stamp_cost),1)])):u("",!0)])]),t("div",ds,[t("a",{href:`call.html?destination_hash=${i.selectedPeer.destination_hash}`,target:"_blank",class:"cursor-pointer"},hs,8,cs)]),t("div",ms,[t("div",{onClick:s[3]||(s[3]=(...o)=>n.deleteConversation&&n.deleteConversation(...o)),class:"cursor-pointer"},fs)]),t("div",_s,[t("div",{onClick:s[4]||(s[4]=(...o)=>n.close&&n.close(...o)),class:"cursor-pointer"},ps)])]),t("div",{onScroll:s[7]||(s[7]=(...o)=>n.onMessagesScroll&&n.onMessagesScroll(...o)),id:"messages",class:"h-full overflow-y-scroll"},[n.selectedPeerChatItems.length>0?(l(),d("div",ws,[(l(!0),d(b,null,A(n.selectedPeerChatItemsReversed,o=>{var m,_,v,x;return l(),d("div",{key:o.lxmf_message.hash,class:y(["flex flex-col max-w-xl mt-3",{"ml-auto pl-4 md:pl-16 items-end":o.is_outbound,"mr-auto pr-4 md:pr-16 items-start":!o.is_outbound}])},[t("div",{onClick:g=>n.onChatItemClick(o),class:y(["border border-gray-300 rounded-xl shadow overflow-hidden",[o.lxmf_message.state==="failed"?"bg-red-500 text-white":o.is_outbound?"bg-[#3b82f6] text-white":"bg-[#efefef]"]])},[t("div",xs,[o.lxmf_message.content?(l(),d("div",bs,h(o.lxmf_message.content),1)):u("",!0),(m=o.lxmf_message.fields)!=null&&m.image?(l(),d("div",ks,[t("img",{onClick:k(g=>{n.openImage(`data:image/${o.lxmf_message.fields.image.image_type};base64,${o.lxmf_message.fields.image.image_bytes}`)},["stop"]),src:`data:image/${o.lxmf_message.fields.image.image_type};base64,${o.lxmf_message.fields.image.image_bytes}`,class:"w-full rounded-md cursor-pointer"},null,8,As)])):u("",!0),(_=o.lxmf_message.fields)!=null&&_.audio?(l(),d("div",Cs,[a.lxmfMessageAudioAttachmentCache[o.lxmf_message.hash]?(l(),d("audio",Ms,[t("source",{src:a.lxmfMessageAudioAttachmentCache[o.lxmf_message.hash],type:"audio/wav"},null,8,Ps)])):(l(),d("div",Ss,[t("button",{onClick:g=>n.downloadFileFromBase64("audio.bin",o.lxmf_message.fields.audio.audio_bytes),type:"button",class:"my-auto flex border border-gray-300 hover:bg-gray-100 rounded px-2 py-1 text-sm text-gray-700 font-semibold cursor-pointer space-x-2 bg-[#efefef]"},[Ls,t("span",Bs," Unsupported Audio (mode "+h(o.lxmf_message.fields.audio.audio_mode)+") ",1),Ts],8,Rs)]))])):u("",!0),(v=o.lxmf_message.fields)!=null&&v.file_attachments?(l(),d("div",Is,[(l(!0),d(b,null,A(((x=o.lxmf_message.fields)==null?void 0:x.file_attachments)??[],g=>(l(),d("a",{onClick:s[5]||(s[5]=k(()=>{},["stop"])),target:"_blank",download:g.file_name,href:`data:application/octet-stream;base64,${g.file_bytes}`,class:"flex border border-gray-300 hover:bg-gray-100 rounded px-2 py-1 text-sm text-gray-700 font-semibold cursor-pointer space-x-2 bg-[#efefef]"},[Us,t("div",Fs,h(g.file_name),1),js],8,Ds))),256))])):u("",!0)]),o.is_actions_expanded?(l(),d("div",Ns,[t("button",{onClick:k(g=>n.deleteChatItem(o),["stop"]),type:"button",class:"inline-flex items-center gap-x-1 rounded-md bg-red-500 px-2 py-1 text-xs font-semibold text-white shadow-sm hover:bg-red-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-red-500"}," Delete ",8,Vs)])):u("",!0)],10,ys),o.is_outbound?(l(),d("div",{key:0,class:y(["flex text-right",[o.lxmf_message.state==="failed"?"text-red-500":"text-gray-500"]])},[t("div",Zs,[t("div",Os,[t("span",{onClick:g=>n.showSentMessageInfo(o.lxmf_message),class:"space-x-1 cursor-pointer"},[t("span",null,h(o.lxmf_message.state),1),o.lxmf_message.state==="outbound"&&o.lxmf_message.delivery_attempts>=1?(l(),d("span",$s,"(attempt "+h(o.lxmf_message.delivery_attempts+1)+")",1)):u("",!0),o.lxmf_message.state==="sent"&&o.lxmf_message.method==="opportunistic"&&o.lxmf_message.delivery_attempts>=1?(l(),d("span",zs,"(attempt "+h(o.lxmf_message.delivery_attempts)+")",1)):u("",!0),o.lxmf_message.state==="sent"&&o.lxmf_message.method==="propagated"?(l(),d("span",Es,"to propagation node")):u("",!0),o.lxmf_message.state==="sending"?(l(),d("span",Ws,h(o.lxmf_message.progress.toFixed(0))+"%",1)):u("",!0)],8,Hs),o.lxmf_message.state==="failed"?(l(),d("a",{key:0,onClick:g=>n.retrySendingMessage(o),class:"ml-1 cursor-pointer underline text-blue-500"},"retry?",8,qs)):u("",!0)]),o.lxmf_message.state==="delivered"?(l(),d("div",Qs,Ks)):o.lxmf_message.state==="failed"?(l(),d("div",Gs,Xs)):(l(),d("div",et,tt))])],2)):u("",!0),o.is_outbound?u("",!0):(l(),d("div",ot,[t("span",{onClick:g=>n.showReceivedMessageInfo(o.lxmf_message),class:"cursor-pointer"},h(n.formatTimeAgo(o.lxmf_message.created_at)),9,nt)]))],2)}),128)),C(t("button",{id:"load-previous",onClick:s[6]||(s[6]=(...o)=>n.loadPrevious&&n.loadPrevious(...o)),type:"button",class:"flex space-x-2 mx-auto bg-gray-200 px-3 py-1 hover:bg-gray-300 rounded-full shadow"},rt,512),[[O,!a.isLoadingPrevious&&a.hasMorePrevious]])])):u("",!0)],32),t("div",lt,[t("div",dt,[t("div",null,[a.newMessageImage?(l(),d("div",ct,[t("div",ut,[a.newMessageImageUrl?(l(),d("img",{key:0,src:a.newMessageImageUrl,class:"w-full h-full object-cover"},null,8,ht)):u("",!0),t("div",mt,[t("div",{onClick:s[8]||(s[8]=(...o)=>n.removeImageAttachment&&n.removeImageAttachment(...o)),class:"cursor-pointer"},ft)]),t("div",_t,[t("div",vt,h(n.formatBytes(a.newMessageImage.size)),1)])])])):u("",!0),a.newMessageAudio?(l(),d("div",pt,[t("div",wt,[t("div",yt,[t("div",xt,[t("div",null,[t("audio",bt,[t("source",{src:a.newMessageAudio.audio_preview_url,type:"audio/wav"},null,8,kt)])]),t("div",At,h(n.formatBytes(a.newMessageAudio.audio_blob.size)),1)]),t("div",{onClick:s[9]||(s[9]=(...o)=>n.removeAudioAttachment&&n.removeAudioAttachment(...o)),class:"flex my-auto text-sm text-gray-500 h-full px-1 hover:bg-gray-200 cursor-pointer"},Mt)])])])):u("",!0),a.newMessageFiles.length>0?(l(),d("div",Pt,[t("div",St,[(l(!0),d(b,null,A(a.newMessageFiles,o=>(l(),d("div",Rt,[t("div",Lt,[t("span",Bt,h(o.name),1),t("span",Tt,h(n.formatBytes(o.size)),1)]),t("div",{onClick:m=>n.removeFileAttachment(o),class:"flex my-auto text-sm text-gray-500 h-full px-1 hover:bg-gray-200 cursor-pointer"},Ut,8,It)]))),256))])])):u("",!0),C(t("textarea",{id:"message-input",readonly:a.isSendingMessage,"onUpdate:modelValue":s[10]||(s[10]=o=>a.newMessageText=o),onKeydown:[s[11]||(s[11]=I(k((...o)=>n.onEnterPressed&&n.onEnterPressed(...o),["exact","prevent"]),["enter","native"])),s[12]||(s[12]=I(k((...o)=>n.onShiftEnterPressed&&n.onShiftEnterPressed(...o),["shift","exact","prevent"]),["enter","native"]))],class:"bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5",rows:"3",placeholder:"Send a message..."},null,40,Ft),[[L,a.newMessageText]]),t("div",jt,[t("button",{onClick:s[13]||(s[13]=(...o)=>n.addFilesToMessage&&n.addFilesToMessage(...o)),type:"button",class:"my-auto mr-1 inline-flex items-center gap-x-1 rounded-md bg-gray-500 px-2.5 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-gray-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-500"},Zt),t("button",{onClick:s[14]||(s[14]=(...o)=>n.addImageToMessage&&n.addImageToMessage(...o)),type:"button",class:"my-auto mr-1 inline-flex items-center gap-x-1 rounded-md bg-gray-500 px-2.5 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-gray-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-500"},$t),t("div",null,[M(c,{"is-recording-audio-attachment":a.isRecordingAudioAttachment,onStartRecording:s[15]||(s[15]=o=>n.startRecordingAudioAttachment(o)),onStopRecording:n.stopRecordingAudioAttachment},{default:U(()=>[t("span",null,"Recording: "+h(a.audioAttachmentRecordingDuration),1)]),_:1},8,["is-recording-audio-attachment","onStopRecording"])]),t("button",{onClick:s[16]||(s[16]=(...o)=>n.sendMessage&&n.sendMessage(...o)),disabled:!n.canSendMessage,type:"button",class:y(["ml-auto my-auto inline-flex items-center gap-x-1 rounded-md px-2.5 py-1.5 text-sm font-semibold text-white shadow-sm focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2",[n.canSendMessage?"bg-blue-500 hover:bg-blue-400 focus-visible:outline-blue-500":"bg-gray-400 focus-visible:outline-gray-500 cursor-not-allowed"]])},[a.isSendingMessage?(l(),d("span",Et,"Sending...")):(l(),d("span",Wt,"Send"))],10,zt)])])])]),t("input",{ref:"image-input",onChange:s[17]||(s[17]=(...o)=>n.onImageInputChange&&n.onImageInputChange(...o)),type:"file",accept:"image/*",style:{display:"none"}},null,544),t("input",{ref:"file-input",onChange:s[18]||(s[18]=(...o)=>n.onFileInputChange&&n.onFileInputChange(...o)),type:"file",multiple:"",style:{display:"none"}},null,544)])):(l(),d("div",qt,Gt))}const Xt=S(es,[["render",Jt]]),eo={name:"MessagesPage",components:{ConversationViewer:Xt,MessagesSidebar:Ze},data(){return{reloadInterval:null,config:null,peers:{},selectedPeer:null,conversations:[],lxmfDeliveryAnnounces:[]}},beforeUnmount(){clearInterval(this.reloadInterval),P.off("message",this.onWebsocketMessage),D.off("compose-new-message",this.onComposeNewMessage)},mounted(){P.on("message",this.onWebsocketMessage),D.on("compose-new-message",this.onComposeNewMessage),this.getConfig(),this.getConversations(),this.getLxmfDeliveryAnnounces(),this.reloadInterval=setInterval(()=>{this.getConversations()},5e3)},methods:{async onComposeNewMessage(e){if(e==null&&(e=await f.prompt("Enter LXMF Address"),!e))return;const s=this.peers[e];if(s){this.onPeerClick(s);return}if(e.length!==32){f.alert("Invalid Address");return}this.onPeerClick({display_name:"Unknown Peer",destination_hash:e})},async getConfig(){try{const e=await window.axios.get("/api/v1/config");this.config=e.data.config}catch(e){console.log(e)}},async onWebsocketMessage(e){const s=JSON.parse(e.data);switch(s.type){case"config":{this.config=s.config;break}case"announce":{s.announce.aspect==="lxmf.delivery"&&this.updatePeerFromAnnounce(s.announce);break}case"lxmf.delivery":{await this.getConversations();break}}},async getLxmfDeliveryAnnounces(){try{const s=(await window.axios.get("/api/v1/announces",{params:{aspect:"lxmf.delivery",limit:500}})).data.announces;for(const i of s)this.updatePeerFromAnnounce(i)}catch(e){console.log(e)}},async getConversations(){try{const e=await window.axios.get("/api/v1/lxmf/conversations");this.conversations=e.data.conversations}catch(e){console.log(e)}},updatePeerFromAnnounce:function(e){this.peers[e.destination_hash]=e},onPeerClick:function(e){this.selectedPeer=e},onConversationClick:function(e){this.onPeerClick(e),this.$refs["conversation-viewer"].markConversationAsRead(e)}},watch:{conversations(){H.unreadConversationsCount=this.conversations.filter(e=>e.is_unread).length}}},so={class:"flex flex-col flex-1 overflow-hidden min-w-full sm:min-w-[500px]"};function to(e,s,i,r,a,n){var m,_;const c=B("MessagesSidebar"),o=B("ConversationViewer");return l(),d(b,null,[M(c,{conversations:a.conversations,peers:a.peers,"selected-destination-hash":(m=a.selectedPeer)==null?void 0:m.destination_hash,onConversationClick:n.onConversationClick,onPeerClick:n.onPeerClick},null,8,["conversations","peers","selected-destination-hash","onConversationClick","onPeerClick"]),t("div",so,[M(o,{ref:"conversation-viewer","my-lxmf-address-hash":(_=a.config)==null?void 0:_.lxmf_address_hash,"selected-peer":a.selectedPeer,conversations:a.conversations,onClose:s[0]||(s[0]=v=>a.selectedPeer=null),onReloadConversations:n.getConversations},null,8,["my-lxmf-address-hash","selected-peer","conversations","onReloadConversations"])])],64)}const no=S(eo,[["render",to]]);export{no as default};
