import{_ as C,U as g,o as r,c as l,a as e,n as v,h as k,v as P,b as u,F as p,f as b,t as h,k as U,l as I,e as M,w as T,T as D,W as A,N as F,D as f,r as S,d as V,m as y,p as Z,q as L,G as R,s as j}from"./app-CyGGaqSW.js";const N={name:"MessagesSidebar",props:{peers:Object,conversations:Array,selectedDestinationHash:String},data(){return{tab:"conversations",conversationsSearchTerm:"",peersSearchTerm:""}},methods:{onConversationClick(s){this.$emit("conversation-click",s)},onPeerClick(s){this.$emit("peer-click",s)},formatTimeAgo:function(s){return g.formatTimeAgo(s)}},computed:{searchedConversations(){return this.conversations.filter(s=>{const t=this.conversationsSearchTerm.toLowerCase(),i=s.name.toLowerCase().includes(t),d=s.destination_hash.toLowerCase().includes(t);return i||d})},peersCount(){return Object.keys(this.peers).length},peersOrderedByLatestAnnounce(){return Object.values(this.peers).sort(function(t,i){const d=new Date(t.updated_at).getTime();return new Date(i.updated_at).getTime()-d})},searchedPeers(){return this.peersOrderedByLatestAnnounce.filter(s=>{const t=this.peersSearchTerm.toLowerCase(),i=s.name.toLowerCase().includes(t),d=s.destination_hash.toLowerCase().includes(t);return i||d})}}},H={class:"flex flex-col w-80 min-w-80"},O={class:"bg-white border-b border-r border-gray-200"},z={class:"-mb-px flex"},E={key:0,class:"flex-1 flex flex-col bg-white border-r overflow-hidden"},W={key:0,class:"p-1 border-b border-gray-300"},q=["placeholder"],$={class:"flex h-full overflow-y-auto"},K={key:0,class:"w-full"},Y=["onClick"],G=e("div",{class:"my-auto mr-2"},[e("div",{class:"bg-gray-200 text-gray-500 p-2 rounded"},[e("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-6 h-6"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z"})])])],-1),J={class:"mr-auto"},Q={class:"text-gray-500 text-sm"},X={key:0,class:"my-auto ml-2 mr-2"},ee=e("div",{class:"bg-blue-500 rounded-full p-1"},null,-1),se=[ee],te={key:1,class:"my-auto ml-2 mr-2"},oe=e("div",{class:"bg-red-500 rounded-full p-1"},null,-1),ne=[oe],ie={key:1,class:"mx-auto my-auto text-center leading-5"},ae={key:0,class:"flex flex-col"},re=e("div",{class:"mx-auto mb-1"},[e("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"size-6"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M2.25 13.5h3.86a2.25 2.25 0 0 1 2.012 1.244l.256.512a2.25 2.25 0 0 0 2.013 1.244h3.218a2.25 2.25 0 0 0 2.013-1.244l.256-.512a2.25 2.25 0 0 1 2.013-1.244h3.859m-19.5.338V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18v-4.162c0-.224-.034-.447-.1-.661L19.24 5.338a2.25 2.25 0 0 0-2.15-1.588H6.911a2.25 2.25 0 0 0-2.15 1.588L2.35 13.177a2.25 2.25 0 0 0-.1.661Z"})])],-1),le=e("div",{class:"font-semibold"},"No Conversations",-1),de=e("div",null,"Discover peers on the Announces tab",-1),ce=[re,le,de],ue={key:1,class:"flex flex-col"},he=e("div",{class:"mx-auto mb-1"},[e("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-6 h-6"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"})])],-1),me=e("div",{class:"font-semibold"},"No Search Results",-1),ge=e("div",null,"Your search didn't match any Conversations!",-1),fe=[he,me,ge],ve={key:1,class:"flex-1 flex flex-col bg-white border-r overflow-hidden"},_e={key:0,class:"p-1 border-b border-gray-300"},we=["placeholder"],xe={class:"flex h-full overflow-y-auto"},pe={key:0,class:"w-full"},ye=["onClick"],be=e("div",{class:"my-auto mr-2"},[e("div",{class:"bg-gray-200 text-gray-500 p-2 rounded"},[e("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-6 h-6"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z"})])])],-1),ke={class:"text-gray-900"},Me={class:"text-gray-500 text-sm"},Ae={key:1,class:"mx-auto my-auto text-center leading-5"},Ce={key:0,class:"flex flex-col"},Pe=e("div",{class:"mx-auto mb-1"},[e("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-6 h-6"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z"})])],-1),Se=e("div",{class:"font-semibold"},"No Peers Discovered",-1),Be=e("div",null,"Waiting for someone to announce!",-1),Le=[Pe,Se,Be],Re={key:1,class:"flex flex-col"},Te=e("div",{class:"mx-auto mb-1"},[e("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-6 h-6"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"})])],-1),Ue=e("div",{class:"font-semibold"},"No Search Results",-1),Ie=e("div",null,"Your search didn't match any Peers!",-1),De=[Te,Ue,Ie];function Fe(s,t,i,d,a,n){return r(),l("div",H,[e("div",O,[e("div",z,[e("div",{onClick:t[0]||(t[0]=c=>a.tab="conversations"),class:v(["w-full border-b-2 py-3 px-1 text-center text-sm font-medium cursor-pointer",[a.tab==="conversations"?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700"]])},"Conversations",2),e("div",{onClick:t[1]||(t[1]=c=>a.tab="announces"),class:v(["w-full border-b-2 py-3 px-1 text-center text-sm font-medium cursor-pointer",[a.tab==="announces"?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700"]])},"Announces",2)])]),a.tab==="conversations"?(r(),l("div",E,[i.conversations.length>0?(r(),l("div",W,[k(e("input",{"onUpdate:modelValue":t[2]||(t[2]=c=>a.conversationsSearchTerm=c),type:"text",placeholder:`Search ${i.conversations.length} Conversations...`,class:"bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"},null,8,q),[[P,a.conversationsSearchTerm]])])):u("",!0),e("div",$,[n.searchedConversations.length>0?(r(),l("div",K,[(r(!0),l(p,null,b(n.searchedConversations,c=>(r(),l("div",{onClick:o=>n.onConversationClick(c),class:v(["flex cursor-pointer p-2 border-l-2",[c.destination_hash===i.selectedDestinationHash?"bg-gray-100 border-blue-500":"bg-white border-transparent hover:bg-gray-50 hover:border-gray-200"]])},[G,e("div",J,[e("div",{class:v(["text-gray-900",{"font-semibold":c.is_unread||c.failed_messages_count>0}])},h(c.name),3),e("div",Q,h(n.formatTimeAgo(c.updated_at)),1)]),c.is_unread?(r(),l("div",X,se)):c.failed_messages_count?(r(),l("div",te,ne)):u("",!0)],10,Y))),256))])):(r(),l("div",ie,[i.conversations.length===0?(r(),l("div",ae,ce)):u("",!0),a.conversationsSearchTerm!==""&&i.conversations.length>0?(r(),l("div",ue,fe)):u("",!0)]))])])):u("",!0),a.tab==="announces"?(r(),l("div",ve,[n.peersCount>0?(r(),l("div",_e,[k(e("input",{"onUpdate:modelValue":t[3]||(t[3]=c=>a.peersSearchTerm=c),type:"text",placeholder:`Search ${n.peersCount} recent announces...`,class:"bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"},null,8,we),[[P,a.peersSearchTerm]])])):u("",!0),e("div",xe,[n.searchedPeers.length>0?(r(),l("div",pe,[(r(!0),l(p,null,b(n.searchedPeers,c=>(r(),l("div",{onClick:o=>n.onPeerClick(c),class:v(["flex cursor-pointer p-2 border-l-2",[c.destination_hash===i.selectedDestinationHash?"bg-gray-100 border-blue-500":"bg-white border-transparent hover:bg-gray-50 hover:border-gray-200"]])},[be,e("div",null,[e("div",ke,h(c.name),1),e("div",Me,h(n.formatTimeAgo(c.updated_at)),1)])],10,ye))),256))])):(r(),l("div",Ae,[n.peersCount===0?(r(),l("div",Ce,Le)):u("",!0),a.peersSearchTerm!==""&&n.peersCount>0?(r(),l("div",Re,De)):u("",!0)]))])])):u("",!0)])}const Ve=C(N,[["render",Fe]]),Ze={name:"AddAudioButton",props:{isRecordingAudioAttachment:Boolean},data(){return{isShowingMenu:!1}},methods:{showMenu(){this.isShowingMenu=!0},hideMenu(){this.isShowingMenu=!1},startRecordingAudioAttachment(s){this.isShowingMenu=!1,this.$emit("start-recording",s)},startRecordingCodec2(s){this.startRecordingAudioAttachment({codec:"codec2",mode:s})},stopRecordingAudioAttachment(){this.isShowingMenu=!1,this.$emit("stop-recording")}}},je={class:"inline-flex rounded-md shadow-sm"},Ne=e("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",class:"size-5"},[e("path",{d:"M7 4a3 3 0 0 1 6 0v6a3 3 0 1 1-6 0V4Z"}),e("path",{d:"M5.5 9.643a.75.75 0 0 0-1.5 0V10c0 3.06 2.29 5.585 5.25 5.954V17.5h-1.5a.75.75 0 0 0 0 1.5h4.5a.75.75 0 0 0 0-1.5h-1.5v-1.546A6.001 6.001 0 0 0 16 10v-.357a.75.75 0 0 0-1.5 0V10a4.5 4.5 0 0 1-9 0v-.357Z"})],-1),He={class:"ml-1"},Oe=e("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",class:"size-5"},[e("path",{d:"M7 4a3 3 0 0 1 6 0v6a3 3 0 1 1-6 0V4Z"}),e("path",{d:"M5.5 9.643a.75.75 0 0 0-1.5 0V10c0 3.06 2.29 5.585 5.25 5.954V17.5h-1.5a.75.75 0 0 0 0 1.5h4.5a.75.75 0 0 0 0-1.5h-1.5v-1.546A6.001 6.001 0 0 0 16 10v-.357a.75.75 0 0 0-1.5 0V10a4.5 4.5 0 0 1-9 0v-.357Z"})],-1),ze=e("span",{class:"ml-1 hidden sm:inline-block"},"Add Voice",-1),Ee=[Oe,ze],We={class:"relative block"},qe={key:0,class:"absolute bottom-0 -ml-11 sm:right-0 sm:ml-0 z-10 mb-10 w-56 rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none"},$e={class:"py-1"};function Ke(s,t,i,d,a,n){const c=U("click-outside");return r(),l("div",je,[i.isRecordingAudioAttachment?(r(),l("button",{key:0,onClick:t[0]||(t[0]=(...o)=>n.stopRecordingAudioAttachment&&n.stopRecordingAudioAttachment(...o)),type:"button",class:"my-auto mr-1 inline-flex items-center gap-x-1 rounded-md bg-red-500 px-2.5 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-red-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-red-500"},[Ne,e("span",He,[I(s.$slots,"default")])])):(r(),l("button",{key:1,onClick:t[1]||(t[1]=(...o)=>n.showMenu&&n.showMenu(...o)),type:"button",class:"my-auto mr-1 inline-flex items-center gap-x-1 rounded-md bg-gray-500 px-2.5 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-gray-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-500"},Ee)),e("div",We,[M(D,{"enter-active-class":"transition ease-out duration-100","enter-from-class":"transform opacity-0 scale-95","enter-to-class":"transform opacity-100 scale-100","leave-active-class":"transition ease-in duration-75","leave-from-class":"transform opacity-100 scale-100","leave-to-class":"transform opacity-0 scale-95"},{default:T(()=>[a.isShowingMenu?k((r(),l("div",qe,[e("div",$e,[e("button",{onClick:t[2]||(t[2]=o=>n.startRecordingCodec2("1200")),type:"button",class:"w-full block text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"},"Codec2 (Low Quality)"),e("button",{onClick:t[3]||(t[3]=o=>n.startRecordingCodec2("3200")),type:"button",class:"w-full block text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"},"Codec2 (Medium Quality)")])])),[[c,n.hideMenu]]):u("",!0)]),_:1})])])}const Ye=C(Ze,[["render",Ke]]),Ge={name:"ConversationViewer",components:{AddAudioButton:Ye},props:{myLxmfAddressHash:String,selectedPeer:Object,conversations:Array},data(){return{selectedPeerPath:null,lxmfMessagesRequestSequence:0,chatItems:[],isLoadingPrevious:!1,hasMorePrevious:!0,newMessageText:"",newMessageImage:null,newMessageImageUrl:null,newMessageAudio:null,newMessageFiles:[],isSendingMessage:!1,autoScrollOnNewMessage:!0,isRecordingAudioAttachment:!1,audioAttachmentMicrophoneRecorder:null,audioAttachmentRecordingStartedAt:null,audioAttachmentRecordingDuration:null,audioAttachmentRecordingTimer:null,lxmfMessageAudioAttachmentCache:{},lxmfAudioModeToCodec2ModeMap:{1:"450PWB",2:"450",3:"700C",4:"1200",5:"1300",6:"1400",7:"1600",8:"2400",9:"3200"}}},beforeUnmount(){A.off("message",this.onWebsocketMessage)},mounted(){A.on("message",this.onWebsocketMessage)},methods:{close(){this.$emit("close")},onMessagesScroll(s){const t=s.target,i=t.scrollTop===t.scrollHeight-t.offsetHeight;this.autoScrollOnNewMessage=i,t.scrollTop<=500&&this.loadPrevious()},async initialLoad(){this.chatItems=[],this.hasMorePrevious=!0,this.selectedPeer&&(this.getPeerPath(),await this.loadPrevious(),this.scrollMessagesToBottom())},async loadPrevious(){if(!this.isLoadingPrevious){this.isLoadingPrevious=!0;try{const s=++this.lxmfMessagesRequestSequence,t=30,i=await window.axios.get(`/api/v1/lxmf-messages/conversation/${this.selectedPeer.destination_hash}`,{params:{count:t,order:"desc",after_id:this.oldestMessageId}});if(s!==this.lxmfMessagesRequestSequence){console.log("ignoring response for previous lxmf messages request");return}const d=[],a=i.data.lxmf_messages;for(const n of a)d.push({type:"lxmf_message",is_outbound:this.myLxmfAddressHash===n.source_hash,lxmf_message:n});for(const n of d)this.chatItems.unshift(n);d.length<t&&(this.hasMorePrevious=!1)}catch{}finally{this.isLoadingPrevious=!1}}},async onWebsocketMessage(s){const t=JSON.parse(s.data);switch(t.type){case"lxmf.delivery":{this.onLxmfMessageReceived(t.lxmf_message),await this.getPeerPath();break}case"lxmf_message_created":{this.onLxmfMessageCreated(t.lxmf_message),await this.getPeerPath();break}case"lxmf_message_state_updated":{this.onLxmfMessageUpdated(t.lxmf_message);break}case"lxmf_message_deleted":{this.onLxmfMessageDeleted(t.hash);break}}},onLxmfMessageReceived(s){var t;if(this.chatItems.push({type:"lxmf_message",lxmf_message:s}),s.source_hash===((t=this.selectedPeer)==null?void 0:t.destination_hash)){const i=this.findConversation(this.selectedPeer.destination_hash);i&&this.markConversationAsRead(i)}document.hasFocus()||F.showNewMessageNotification(),this.autoScrollOnNewMessage&&this.scrollMessagesToBottom()},onLxmfMessageCreated(s){this.isLxmfMessageInUi(s.hash)||this.chatItems.push({type:"lxmf_message",lxmf_message:s,is_outbound:!0})},onLxmfMessageUpdated(s){const t=s.hash,i=this.chatItems.findIndex(d=>{var a;return((a=d.lxmf_message)==null?void 0:a.hash)===t});if(i===-1){console.log("did not find existing chat item index for lxmf message hash: "+s.hash);return}this.chatItems[i].lxmf_message=s},onLxmfMessageDeleted(s){s&&(this.chatItems=this.chatItems.filter(t=>{var i;return((i=t.lxmf_message)==null?void 0:i.hash)!==s}))},async getPeerPath(){if(this.selectedPeerPath=null,this.selectedPeer)try{const s=await window.axios.get(`/api/v1/destination/${this.selectedPeer.destination_hash}/path`);this.selectedPeerPath=s.data.path}catch(s){console.log(s)}},onDestinationPathClick(s){f.alert(`${s.hops} ${s.hops===1?"hop":"hops"} away via ${s.next_hop_interface}`)},scrollMessagesToBottom:function(){this.$nextTick(()=>{setTimeout(()=>{const s=document.getElementById("messages");s&&(s.scrollTop=s.scrollHeight)},0)})},isLxmfMessageInUi:function(s){return this.chatItems.findIndex(t=>{var i;return((i=t.lxmf_message)==null?void 0:i.hash)===s})!==-1},async deleteConversation(){if(this.selectedPeer&&confirm("Are you sure you want to delete all messages from this conversation? This can not be undone!")){try{await window.axios.delete(`/api/v1/lxmf-messages/conversation/${this.selectedPeer.destination_hash}`)}catch(s){f.alert("failed to delete conversation"),console.log(s)}await this.initialLoad(),this.$emit("reload-conversations")}},onChatItemClick:function(s){s.is_actions_expanded?s.is_actions_expanded=!1:s.is_actions_expanded=!0},openImage:async function(s){const t=await(await fetch(s)).blob(),i=window.URL.createObjectURL(t);window.open(i)},downloadFileFromBase64:async function(s,t){const i=atob(t),d=new Array(i.length);for(let m=0;m<i.length;m++)d[m]=i.charCodeAt(m);const a=new Uint8Array(d),n=new Blob([a]),c=URL.createObjectURL(n),o=document.createElement("a");o.href=c,o.download=s,o.style.display="none",document.body.append(o),o.click(),o.remove(),setTimeout(()=>URL.revokeObjectURL(c),1e4)},async processAudioForSelectedPeerChatItems(){var s,t;for(const i of this.selectedPeerChatItems){if(!((t=(s=i.lxmf_message)==null?void 0:s.fields)!=null&&t.audio)||this.lxmfMessageAudioAttachmentCache[i.lxmf_message.hash])continue;const d=await this.decodeLxmfAudioFieldToBlobUrl(i.lxmf_message.fields.audio);d&&(this.lxmfMessageAudioAttachmentCache[i.lxmf_message.hash]=d)}},async decodeLxmfAudioFieldToBlobUrl(s){try{const t=s.audio_mode,i=s.audio_bytes;if(t===16)return this.decodeOpusAudioToBlobUrl(s.audio_bytes);const d=this.lxmfAudioModeToCodec2ModeMap[t];if(!d)return console.log("unsupported audio mode: "+t),null;const a=this.base64ToArrayBuffer(i),n=await Codec2Lib.runDecode(d,new Uint8Array(a)),c=await Codec2Lib.rawToWav(n),o=new Blob([c],{type:"audio/wav"});return URL.createObjectURL(o)}catch(t){return console.log(t),null}},async decodeOpusAudioToBlobUrl(s){try{const t=this.base64ToArrayBuffer(s),i=new Blob([t],{type:"audio/opus"});return URL.createObjectURL(i)}catch(t){return console.log(t),null}},base64ToArrayBuffer:function(s){return Uint8Array.from(atob(s),t=>t.charCodeAt(0))},async deleteChatItem(s,t=!0){try{if(t&&!confirm("Are you sure you want to delete this message? This can not be undone!")||s.type!=="lxmf_message")return;await window.axios.delete(`/api/v1/lxmf-messages/${s.lxmf_message.hash}`),this.chatItems=this.chatItems.filter(i=>{var d;return((d=i.lxmf_message)==null?void 0:d.hash)!==s.lxmf_message.hash})}catch{}},async sendMessage(){var d,a;if(this.canSendMessage&&this.selectedPeer){this.isSendingMessage=!0;try{const n={};var s=0;if(this.newMessageFiles.length>0){const _=[];for(const x of this.newMessageFiles)s+=x.size,_.push({file_name:x.name,file_bytes:g.arrayBufferToBase64(await x.arrayBuffer())});n.file_attachments=_}var t=0;this.newMessageImage&&(t=this.newMessageImage.size,n.image={image_type:this.newMessageImage.type.replace("image/",""),image_bytes:g.arrayBufferToBase64(await this.newMessageImage.arrayBuffer())});var i=0;this.newMessageAudio&&(i=this.newMessageAudio.size,n.audio={audio_mode:this.newMessageAudio.audio_mode,audio_bytes:g.arrayBufferToBase64(await this.newMessageAudio.audio_blob.arrayBuffer())});const o=this.newMessageText.length+s+t+i;if(o>1e3*900&&!confirm(`Your message exceeds 900KB (It's ${this.formatBytes(o)}). It may be rejected by the recipient unless they have increased their delivery limit. Do you want to try sending anyway?`))return;const m=await window.axios.post("/api/v1/lxmf-messages/send",{lxmf_message:{destination_hash:this.selectedPeer.destination_hash,content:this.newMessageText,fields:n}});this.isLxmfMessageInUi(m.data.lxmf_message.hash)||this.chatItems.push({type:"lxmf_message",lxmf_message:m.data.lxmf_message,is_outbound:!0}),this.scrollMessagesToBottom(),this.newMessageText="",this.newMessageImage=null,this.newMessageImageUrl=null,this.newMessageAudio=null,this.newMessageFiles=[],this.clearImageInput(),this.clearFileInput()}catch(n){const c=((a=(d=n.response)==null?void 0:d.data)==null?void 0:a.message)??"failed to send message";f.alert(c),console.log(n)}finally{this.isSendingMessage=!1}}},async retrySendingMessage(s){var t,i;await this.deleteChatItem(s,!1);try{const d=await window.axios.post("/api/v1/lxmf-messages/send",{lxmf_message:{destination_hash:s.lxmf_message.destination_hash,content:s.lxmf_message.content,fields:s.lxmf_message.fields}});this.isLxmfMessageInUi(d.data.lxmf_message.hash)||this.chatItems.push({type:"lxmf_message",lxmf_message:d.data.lxmf_message,is_outbound:!0}),this.scrollMessagesToBottom()}catch(d){const a=((i=(t=d.response)==null?void 0:t.data)==null?void 0:i.message)??"failed to send message";f.alert(a),console.log(d)}},formatSecondsAgo:function(s){return g.formatSecondsAgo(s)},formatBytes:function(s){return g.formatBytes(s)},onFileInputChange:function(s){for(const t of s.target.files)this.newMessageFiles.push(t)},clearFileInput:function(){this.$refs["file-input"].value=null},removeImageAttachment:function(){this.newMessageImage=null,this.newMessageImageUrl=null},onImageInputChange:function(s){if(s.target.files.length>0){this.newMessageImage=s.target.files[0];const t=new FileReader;t.onload=i=>{this.newMessageImageUrl=i.target.result},t.readAsDataURL(this.newMessageImage),this.clearImageInput()}},clearImageInput:function(){this.$refs["image-input"].value=null},async startRecordingAudioAttachment(s){if(!this.isRecordingAudioAttachment&&!(this.newMessageAudio&&!confirm("An audio recording is already attached. A new recording will replace it. Do you want to continue?")))switch(s.codec){case"codec2":{this.audioAttachmentMicrophoneRecorder=new Codec2MicrophoneRecorder,this.audioAttachmentMicrophoneRecorder.codec2Mode=s.mode,this.audioAttachmentRecordingStartedAt=Date.now(),this.isRecordingAudioAttachment=await this.audioAttachmentMicrophoneRecorder.start(),this.audioAttachmentRecordingDuration=g.formatMinutesSeconds(0),this.audioAttachmentRecordingTimer=setInterval(()=>{const i=(Date.now()-this.audioAttachmentRecordingStartedAt)/1e3;this.audioAttachmentRecordingDuration=g.formatMinutesSeconds(i)},1e3),this.isRecordingAudioAttachment||f.alert("failed to start recording");break}default:{f.alert(`Unhandled microphone recorder codec: ${s.codec}`);break}}},async stopRecordingAudioAttachment(){if(clearInterval(this.audioAttachmentRecordingTimer),!this.isRecordingAudioAttachment)return;this.isRecordingAudioAttachment=!1;const s=await this.audioAttachmentMicrophoneRecorder.stop();if(s.length===0)return;const t=this.audioAttachmentMicrophoneRecorder.codec2Mode,i=await Codec2Lib.runDecode(t,new Uint8Array(s)),d=await Codec2Lib.rawToWav(i),a=new Blob([d],{type:"audio/wav"});var n=null;switch(t){case"1200":{n=4;break}case"3200":{n=9;break}default:{f.alert(`Unhandled microphone recorder codec2Mode: ${t}`);return}}this.newMessageAudio={audio_mode:n,audio_blob:new Blob([s]),audio_wav_url:URL.createObjectURL(a)}},removeAudioAttachment:function(){confirm("Are you sure you want to remove this audio attachment?")&&(this.newMessageAudio=null)},removeFileAttachment:function(s){this.newMessageFiles=this.newMessageFiles.filter(t=>t!==s)},addNewLine:function(){this.newMessageText+=`
`},onEnterPressed:function(){if(this.isMobile){this.addNewLine();return}this.sendMessage()},onShiftEnterPressed:function(){this.addNewLine()},addFilesToMessage:function(){this.$refs["file-input"].click()},addImageToMessage:function(){this.$refs["image-input"].click()},findConversation:function(s){return this.conversations.find(t=>t.destination_hash===s)},async markConversationAsRead(s){s.is_unread=!1;try{await window.axios.get(`/api/v1/lxmf/conversations/${s.destination_hash}/mark-as-read`)}catch(t){console.log(t)}this.$emit("reload-conversations")}},computed:{isMobile(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)},canSendMessage(){const s=this.newMessageText.trim();return!(s==null||s===""||this.isSendingMessage)},selectedPeerChatItems(){return this.selectedPeer?this.chatItems.filter(s=>{if(s.type==="lxmf_message"){const t=s.lxmf_message.source_hash===this.selectedPeer.destination_hash,i=s.lxmf_message.destination_hash===this.selectedPeer.destination_hash;return t||i}return!1}):[]},selectedPeerChatItemsReversed(){return this.selectedPeerChatItems.map(s=>s).reverse()},oldestMessageId(){return this.selectedPeerChatItems.length>0?this.selectedPeerChatItems[0].lxmf_message.id:null}},watch:{selectedPeer(){this.initialLoad()},async selectedPeerChatItems(){await this.processAudioForSelectedPeerChatItems()}}},Je={key:0,class:"m-2 flex flex-col h-full border rounded-xl bg-white shadow overflow-hidden"},Qe={class:"flex p-2 border-b border-gray-300"},Xe={class:"font-semibold"},es={class:"text-sm"},ss={class:"ml-auto my-auto mr-2"},ts=["href"],os=e("div",{class:"flex text-gray-700 bg-gray-100 hover:bg-gray-200 p-2 rounded-full"},[e("div",null,[e("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-5 h-5"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 0 0 2.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 0 1-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 0 0-1.091-.852H4.5A2.25 2.25 0 0 0 2.25 4.5v2.25Z"})])])],-1),ns=[os],is={class:"my-auto mr-2"},as=e("div",{class:"flex text-gray-700 bg-gray-100 hover:bg-gray-200 p-2 rounded-full"},[e("div",null,[e("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-5 h-5"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"})])])],-1),rs=[as],ls={class:"my-auto mr-2"},ds=e("div",{class:"flex text-gray-700 bg-gray-100 hover:bg-gray-200 p-2 rounded-full"},[e("div",null,[e("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",class:"w-5 h-5"},[e("path",{d:"M6.28 5.22a.75.75 0 0 0-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 1 0 1.06 1.06L10 11.06l3.72 3.72a.75.75 0 1 0 1.06-1.06L11.06 10l3.72-3.72a.75.75 0 0 0-1.06-1.06L10 8.94 6.28 5.22Z"})])])],-1),cs=[ds],us={key:0,class:"flex flex-col flex-col-reverse p-3"},hs=["onClick"],ms={class:"w-full space-y-0.5 px-2.5 py-1"},gs={key:0,style:{"white-space":"pre-wrap","word-break":"break-word","font-family":"inherit"}},fs={key:1},vs=["onClick","src"],_s={key:2,class:"pb-1"},ws={key:0,controls:"",class:"shadow rounded-full",style:{height:"54px"}},xs=["src"],ps={key:1,style:{"min-height":"54px"},class:"flex"},ys=["onClick"],bs=e("span",{class:"my-auto"},[e("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"size-6"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m9 9 10.5-3m0 6.553v3.75a2.25 2.25 0 0 1-1.632 2.163l-1.32.377a1.803 1.803 0 1 1-.99-3.467l2.31-.66a2.25 2.25 0 0 0 1.632-2.163Zm0 0V2.25L9 5.25v10.303m0 0v3.75a2.25 2.25 0 0 1-1.632 2.163l-1.32.377a1.803 1.803 0 0 1-.99-3.467l2.31-.66A2.25 2.25 0 0 0 9 15.553Z"})])],-1),ks={class:"my-auto w-full"},Ms=e("span",{class:"my-auto"},[e("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-6 h-6"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3"})])],-1),As={key:3,class:"space-y-1"},Cs=["download","href"],Ps=e("div",{class:"my-auto"},[e("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-6 h-6"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m18.375 12.739-7.693 7.693a4.5 4.5 0 0 1-6.364-6.364l10.94-10.94A3 3 0 1 1 19.5 7.372L8.552 18.32m.009-.01-.01.01m5.699-9.941-7.81 7.81a1.5 1.5 0 0 0 2.112 2.13"})])],-1),Ss={class:"my-auto w-full"},Bs=e("div",{class:"my-auto"},[e("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-6 h-6"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3"})])],-1),Ls={key:0,class:"border-t p-1 bg-[#efefef] text-white"},Rs=["onClick"],Ts={class:"flex ml-auto space-x-1"},Us={class:"my-auto space-x-1"},Is={key:0},Ds={key:1},Fs=["onClick"],Vs={key:0,class:"my-auto"},Zs=e("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",class:"w-5 h-5"},[e("path",{"fill-rule":"evenodd",d:"M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 1 0-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 0 0-1.06 1.06l2.25 2.25a.75.75 0 0 0 1.14-.094l3.75-5.25Z","clip-rule":"evenodd"})],-1),js=[Zs],Ns={key:1,class:"my-auto"},Hs=e("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",class:"w-5 h-5"},[e("path",{"fill-rule":"evenodd",d:"M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12ZM12 8.25a.75.75 0 0 1 .75.75v3.75a.75.75 0 0 1-1.5 0V9a.75.75 0 0 1 .75-.75Zm0 8.25a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z","clip-rule":"evenodd"})],-1),Os=[Hs],zs={key:2,class:"my-auto"},Es=e("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-5 h-5"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"})],-1),Ws=[Es],qs={key:1,class:"text-xs text-gray-500 mt-0.5 flex flex-col"},$s={key:0},Ks=e("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"size-6"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m15 11.25-3-3m0 0-3 3m3-3v7.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"})],-1),Ys=e("span",null,"Load Previous",-1),Gs=[Ks,Ys],Js={class:"w-full border-gray-300 border-t p-2"},Qs={class:"mx-auto"},Xs={key:0,class:"mb-2"},et={class:"w-32 h-32 rounded shadow border relative overflow-hidden"},st=["src"],tt={class:"absolute top-0 right-0 p-1"},ot=e("div",{class:"flex text-gray-700 bg-gray-100 hover:bg-gray-200 p-1 rounded-full"},[e("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",class:"w-4 h-4"},[e("path",{d:"M6.28 5.22a.75.75 0 0 0-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 1 0 1.06 1.06L10 11.06l3.72 3.72a.75.75 0 1 0 1.06-1.06L11.06 10l3.72-3.72a.75.75 0 0 0-1.06-1.06L10 8.94 6.28 5.22Z"})])],-1),nt=[ot],it={class:"absolute bottom-0 left-0 p-1"},at={class:"bg-gray-100 rounded border text-sm px-1"},rt={key:1,class:"mb-2"},lt={class:"flex flex-wrap gap-1"},dt={class:"flex border border-gray-300 rounded text-gray-700 divide-x divide-gray-300 overflow-hidden"},ct={class:"flex p-1"},ut={controls:"",class:"h-10"},ht=["src"],mt={class:"my-auto px-1 text-sm text-gray-500"},gt=e("svg",{class:"w-5 h-5 my-auto",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6 18 18 6M6 6l12 12"})],-1),ft=[gt],vt={key:2,class:"mb-2"},_t={class:"flex flex-wrap gap-1"},wt={class:"flex border border-gray-300 rounded text-gray-700 divide-x divide-gray-300 overflow-hidden"},xt={class:"my-auto px-1"},pt={class:"mr-1"},yt={class:"my-auto text-sm text-gray-500"},bt=["onClick"],kt=e("svg",{class:"w-5 h-5 my-auto",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6 18 18 6M6 6l12 12"})],-1),Mt=[kt],At=["readonly"],Ct={class:"flex mt-2"},Pt=e("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",class:"w-5 h-5"},[e("path",{"fill-rule":"evenodd",d:"M5.625 1.5H9a3.75 3.75 0 0 1 3.75 3.75v1.875c0 1.036.84 1.875 1.875 1.875H16.5a3.75 3.75 0 0 1 3.75 3.75v7.875c0 1.035-.84 1.875-1.875 1.875H5.625a1.875 1.875 0 0 1-1.875-1.875V3.375c0-1.036.84-1.875 1.875-1.875ZM12.75 12a.75.75 0 0 0-1.5 0v2.25H9a.75.75 0 0 0 0 1.5h2.25V18a.75.75 0 0 0 1.5 0v-2.25H15a.75.75 0 0 0 0-1.5h-2.25V12Z","clip-rule":"evenodd"}),e("path",{d:"M14.25 5.25a5.23 5.23 0 0 0-1.279-3.434 9.768 9.768 0 0 1 6.963 6.963A5.23 5.23 0 0 0 16.5 7.5h-1.875a.375.375 0 0 1-.375-.375V5.25Z"})],-1),St=e("span",{class:"ml-1 hidden sm:inline-block"},"Add Files",-1),Bt=[Pt,St],Lt=e("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",class:"w-5 h-5"},[e("path",{"fill-rule":"evenodd",d:"M1.5 6a2.25 2.25 0 0 1 2.25-2.25h16.5A2.25 2.25 0 0 1 22.5 6v12a2.25 2.25 0 0 1-2.25 2.25H3.75A2.25 2.25 0 0 1 1.5 18V6ZM3 16.06V18c0 .414.336.75.75.75h16.5A.75.75 0 0 0 21 18v-1.94l-2.69-2.689a1.5 1.5 0 0 0-2.12 0l-.88.879.97.97a.75.75 0 1 1-1.06 1.06l-5.16-5.159a1.5 1.5 0 0 0-2.12 0L3 16.061Zm10.125-7.81a1.125 1.125 0 1 1 2.25 0 1.125 1.125 0 0 1-2.25 0Z","clip-rule":"evenodd"})],-1),Rt=e("span",{class:"ml-1 hidden sm:inline-block"},"Add Image",-1),Tt=[Lt,Rt],Ut=["disabled"],It={key:0},Dt={key:1},Ft={key:1,class:"flex flex-col mx-auto my-auto text-center leading-5"},Vt=e("div",{class:"mx-auto mb-1"},[e("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor",class:"w-6 h-6"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193-.34.027-.68.052-1.02.072v3.091l-3-3c-1.354 0-2.694-.055-4.02-.163a2.115 2.115 0 0 1-.825-.242m9.345-8.334a2.126 2.126 0 0 0-.476-.095 48.64 48.64 0 0 0-8.048 0c-1.131.094-1.976 1.057-1.976 2.192v4.286c0 .837.46 1.58 1.155 1.951m9.345-8.334V6.637c0-1.621-1.152-3.026-2.76-3.235A48.455 48.455 0 0 0 11.25 3c-2.115 0-4.198.137-6.24.402-1.608.209-2.76 1.614-2.76 3.235v6.226c0 1.621 1.152 3.026 2.76 3.235.577.075 1.157.14 1.74.194V21l4.155-4.155"})])],-1),Zt=e("div",{class:"font-semibold"},"No Active Chat",-1),jt=e("div",null,"Select a Peer to start chatting!",-1),Nt=[Vt,Zt,jt];function Ht(s,t,i,d,a,n){const c=S("AddAudioButton");return i.selectedPeer?(r(),l("div",Je,[e("div",Qe,[e("div",null,[e("div",Xe,h(i.selectedPeer.name),1),e("div",es,[V("<"+h(i.selectedPeer.destination_hash)+"> ",1),a.selectedPeerPath?(r(),l("span",{key:0,onClick:t[0]||(t[0]=o=>n.onDestinationPathClick(a.selectedPeerPath)),class:"cursor-pointer"},h(a.selectedPeerPath.hops)+" "+h(a.selectedPeerPath.hops===1?"hop":"hops")+" away",1)):u("",!0)])]),e("div",ss,[e("a",{href:`call.html?destination_hash=${i.selectedPeer.destination_hash}`,target:"_blank",class:"cursor-pointer"},ns,8,ts)]),e("div",is,[e("div",{onClick:t[1]||(t[1]=(...o)=>n.deleteConversation&&n.deleteConversation(...o)),class:"cursor-pointer"},rs)]),e("div",ls,[e("div",{onClick:t[2]||(t[2]=(...o)=>n.close&&n.close(...o)),class:"cursor-pointer"},cs)])]),e("div",{onScroll:t[5]||(t[5]=(...o)=>n.onMessagesScroll&&n.onMessagesScroll(...o)),id:"messages",class:"h-full overflow-y-scroll"},[n.selectedPeerChatItems.length>0?(r(),l("div",us,[(r(!0),l(p,null,b(n.selectedPeerChatItemsReversed,o=>{var m,_,x,B;return r(),l("div",{class:v(["flex flex-col max-w-xl mt-3",{"ml-auto pl-4 md:pl-16 items-end":o.is_outbound,"mr-auto pr-4 md:pr-16 items-start":!o.is_outbound}])},[e("div",{onClick:w=>n.onChatItemClick(o),class:v(["border border-gray-300 rounded-xl shadow overflow-hidden",[o.lxmf_message.state==="failed"?"bg-red-500 text-white":o.is_outbound?"bg-[#3b82f6] text-white":"bg-[#efefef]"]])},[e("div",ms,[o.lxmf_message.content?(r(),l("div",gs,h(o.lxmf_message.content),1)):u("",!0),(m=o.lxmf_message.fields)!=null&&m.image?(r(),l("div",fs,[e("img",{onClick:y(w=>{n.openImage(`data:image/${o.lxmf_message.fields.image.image_type};base64,${o.lxmf_message.fields.image.image_bytes}`)},["stop"]),src:`data:image/${o.lxmf_message.fields.image.image_type};base64,${o.lxmf_message.fields.image.image_bytes}`,class:"w-full rounded-md cursor-pointer"},null,8,vs)])):u("",!0),(_=o.lxmf_message.fields)!=null&&_.audio?(r(),l("div",_s,[a.lxmfMessageAudioAttachmentCache[o.lxmf_message.hash]?(r(),l("audio",ws,[e("source",{src:a.lxmfMessageAudioAttachmentCache[o.lxmf_message.hash],type:"audio/wav"},null,8,xs)])):(r(),l("div",ps,[e("button",{onClick:w=>n.downloadFileFromBase64("audio.bin",o.lxmf_message.fields.audio.audio_bytes),type:"button",class:"my-auto flex border border-gray-300 hover:bg-gray-100 rounded px-2 py-1 text-sm text-gray-700 font-semibold cursor-pointer space-x-2 bg-[#efefef]"},[bs,e("span",ks," Unsupported Audio (mode "+h(o.lxmf_message.fields.audio.audio_mode)+") ",1),Ms],8,ys)]))])):u("",!0),(x=o.lxmf_message.fields)!=null&&x.file_attachments?(r(),l("div",As,[(r(!0),l(p,null,b(((B=o.lxmf_message.fields)==null?void 0:B.file_attachments)??[],w=>(r(),l("a",{onClick:t[3]||(t[3]=y(()=>{},["stop"])),target:"_blank",download:w.file_name,href:`data:application/octet-stream;base64,${w.file_bytes}`,class:"flex border border-gray-300 hover:bg-gray-100 rounded px-2 py-1 text-sm text-gray-700 font-semibold cursor-pointer space-x-2 bg-[#efefef]"},[Ps,e("div",Ss,h(w.file_name),1),Bs],8,Cs))),256))])):u("",!0)]),o.is_actions_expanded?(r(),l("div",Ls,[e("button",{onClick:y(w=>n.deleteChatItem(o),["stop"]),type:"button",class:"inline-flex items-center gap-x-1 rounded-md bg-red-500 px-2 py-1 text-xs font-semibold text-white shadow-sm hover:bg-red-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-red-500"}," Delete ",8,Rs)])):u("",!0)],10,hs),o.is_outbound?(r(),l("div",{key:0,class:v(["flex text-right",[o.lxmf_message.state==="failed"?"text-red-500":"text-gray-500"]])},[e("div",Ts,[e("div",Us,[e("span",null,h(o.lxmf_message.state),1),o.lxmf_message.state==="outbound"&&o.lxmf_message.delivery_attempts>=1?(r(),l("span",Is,"(attempt "+h(o.lxmf_message.delivery_attempts+1)+")",1)):u("",!0),o.lxmf_message.state==="sending"?(r(),l("span",Ds,h(o.lxmf_message.progress.toFixed(0))+"%",1)):u("",!0),o.lxmf_message.state==="failed"?(r(),l("a",{key:2,onClick:w=>n.retrySendingMessage(o),class:"cursor-pointer underline text-blue-500"},"retry?",8,Fs)):u("",!0)]),o.lxmf_message.state==="delivered"?(r(),l("div",Vs,js)):o.lxmf_message.state==="failed"?(r(),l("div",Ns,Os)):(r(),l("div",zs,Ws))])],2)):u("",!0),o.is_outbound?u("",!0):(r(),l("div",qs,[o.is_actions_expanded&&o.lxmf_message.quality&&o.lxmf_message.rssi&&o.lxmf_message.snr?(r(),l("span",$s,"Signal "+h(o.lxmf_message.quality)+"% • RSSI "+h(o.lxmf_message.rssi)+" • SNR "+h(o.lxmf_message.snr),1)):u("",!0),e("span",null,h(n.formatSecondsAgo(o.lxmf_message.timestamp)),1)]))],2)}),256)),k(e("button",{id:"load-previous",onClick:t[4]||(t[4]=(...o)=>n.loadPrevious&&n.loadPrevious(...o)),type:"button",class:"flex space-x-2 mx-auto bg-gray-200 px-3 py-1 hover:bg-gray-300 rounded-full shadow"},Gs,512),[[Z,!a.isLoadingPrevious&&a.hasMorePrevious]])])):u("",!0)],32),e("div",Js,[e("div",Qs,[e("div",null,[a.newMessageImage?(r(),l("div",Xs,[e("div",et,[a.newMessageImageUrl?(r(),l("img",{key:0,src:a.newMessageImageUrl,class:"w-full h-full"},null,8,st)):u("",!0),e("div",tt,[e("div",{onClick:t[6]||(t[6]=(...o)=>n.removeImageAttachment&&n.removeImageAttachment(...o)),class:"cursor-pointer"},nt)]),e("div",it,[e("div",at,h(n.formatBytes(a.newMessageImage.size)),1)])])])):u("",!0),a.newMessageAudio?(r(),l("div",rt,[e("div",lt,[e("div",dt,[e("div",ct,[e("div",null,[e("audio",ut,[e("source",{src:a.newMessageAudio.audio_wav_url,type:"audio/wav"},null,8,ht)])]),e("div",mt,h(n.formatBytes(a.newMessageAudio.audio_blob.size)),1)]),e("div",{onClick:t[7]||(t[7]=(...o)=>n.removeAudioAttachment&&n.removeAudioAttachment(...o)),class:"flex my-auto text-sm text-gray-500 h-full px-1 hover:bg-gray-200 cursor-pointer"},ft)])])])):u("",!0),a.newMessageFiles.length>0?(r(),l("div",vt,[e("div",_t,[(r(!0),l(p,null,b(a.newMessageFiles,o=>(r(),l("div",wt,[e("div",xt,[e("span",pt,h(o.name),1),e("span",yt,h(n.formatBytes(o.size)),1)]),e("div",{onClick:m=>n.removeFileAttachment(o),class:"flex my-auto text-sm text-gray-500 h-full px-1 hover:bg-gray-200 cursor-pointer"},Mt,8,bt)]))),256))])])):u("",!0),k(e("textarea",{id:"message-input",readonly:a.isSendingMessage,"onUpdate:modelValue":t[8]||(t[8]=o=>a.newMessageText=o),onKeydown:[t[9]||(t[9]=L(y((...o)=>n.onEnterPressed&&n.onEnterPressed(...o),["exact","prevent"]),["enter","native"])),t[10]||(t[10]=L(y((...o)=>n.onShiftEnterPressed&&n.onShiftEnterPressed(...o),["shift","exact","prevent"]),["enter","native"]))],class:"bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5",rows:"3",placeholder:"Send a message..."},null,40,At),[[P,a.newMessageText]]),e("div",Ct,[e("button",{onClick:t[11]||(t[11]=(...o)=>n.addFilesToMessage&&n.addFilesToMessage(...o)),type:"button",class:"my-auto mr-1 inline-flex items-center gap-x-1 rounded-md bg-gray-500 px-2.5 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-gray-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-500"},Bt),e("button",{onClick:t[12]||(t[12]=(...o)=>n.addImageToMessage&&n.addImageToMessage(...o)),type:"button",class:"my-auto mr-1 inline-flex items-center gap-x-1 rounded-md bg-gray-500 px-2.5 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-gray-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-500"},Tt),e("div",null,[M(c,{"is-recording-audio-attachment":a.isRecordingAudioAttachment,onStartRecording:t[13]||(t[13]=o=>n.startRecordingAudioAttachment(o)),onStopRecording:n.stopRecordingAudioAttachment},{default:T(()=>[e("span",null,"Recording: "+h(a.audioAttachmentRecordingDuration),1)]),_:1},8,["is-recording-audio-attachment","onStopRecording"])]),e("button",{onClick:t[14]||(t[14]=(...o)=>n.sendMessage&&n.sendMessage(...o)),disabled:!n.canSendMessage,type:"button",class:v(["ml-auto my-auto inline-flex items-center gap-x-1 rounded-md px-2.5 py-1.5 text-sm font-semibold text-white shadow-sm focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2",[n.canSendMessage?"bg-blue-500 hover:bg-blue-400 focus-visible:outline-blue-500":"bg-gray-400 focus-visible:outline-gray-500 cursor-not-allowed"]])},[a.isSendingMessage?(r(),l("span",It,"Sending...")):(r(),l("span",Dt,"Send"))],10,Ut)])])])]),e("input",{ref:"image-input",onChange:t[15]||(t[15]=(...o)=>n.onImageInputChange&&n.onImageInputChange(...o)),type:"file",accept:"image/*",style:{display:"none"}},null,544),e("input",{ref:"file-input",onChange:t[16]||(t[16]=(...o)=>n.onFileInputChange&&n.onFileInputChange(...o)),type:"file",multiple:"",style:{display:"none"}},null,544)])):(r(),l("div",Ft,Nt))}const Ot=C(Ge,[["render",Ht]]),zt={name:"MessagesPage",components:{ConversationViewer:Ot,MessagesSidebar:Ve},data(){return{reloadInterval:null,config:null,peers:{},selectedPeer:null,conversations:[],lxmfDeliveryAnnounces:[]}},beforeUnmount(){clearInterval(this.reloadInterval),A.off("message",this.onWebsocketMessage),R.off("compose-new-message",this.onComposeNewMessage)},mounted(){A.on("message",this.onWebsocketMessage),R.on("compose-new-message",this.onComposeNewMessage),this.getConfig(),this.getConversations(),this.getLxmfDeliveryAnnounces(),this.reloadInterval=setInterval(()=>{this.getConversations()},5e3)},methods:{async onComposeNewMessage(){const s=await f.prompt("Enter LXMF Address");if(!s)return;const t=this.peers[s];if(t){this.onPeerClick(t);return}if(s.length!==32){f.alert("Invalid Address");return}this.onPeerClick({name:"Unknown Peer",destination_hash:s})},async getConfig(){try{const s=await window.axios.get("/api/v1/config");this.config=s.data.config}catch(s){console.log(s)}},async onWebsocketMessage(s){const t=JSON.parse(s.data);switch(t.type){case"config":{this.config=t.config;break}case"announce":{t.announce.aspect==="lxmf.delivery"&&this.updatePeerFromAnnounce(t.announce);break}case"lxmf.delivery":{await this.getConversations();break}}},async getLxmfDeliveryAnnounces(){try{const t=(await window.axios.get("/api/v1/announces",{params:{aspect:"lxmf.delivery",limit:500}})).data.announces;for(const i of t)this.updatePeerFromAnnounce(i)}catch(s){console.log(s)}},async getConversations(){try{const s=await window.axios.get("/api/v1/lxmf/conversations");this.conversations=s.data.conversations}catch(s){console.log(s)}},getPeerNameFromAppData:function(s){try{return g.decodeBase64ToUtf8String(s)}catch{return"Anonymous Peer"}},updatePeerFromAnnounce:function(s){this.peers[s.destination_hash]={...s,name:this.getPeerNameFromAppData(s.app_data)}},onPeerClick:function(s){this.selectedPeer=s},onConversationClick:function(s){this.onPeerClick(s),this.$refs["conversation-viewer"].markConversationAsRead(s)}},watch:{conversations(){j.unreadConversationsCount=this.conversations.filter(s=>s.is_unread).length}}},Et={class:"flex flex-col flex-1 overflow-hidden min-w-full sm:min-w-[500px]"};function Wt(s,t,i,d,a,n){var m,_;const c=S("MessagesSidebar"),o=S("ConversationViewer");return r(),l(p,null,[M(c,{conversations:a.conversations,peers:a.peers,"selected-destination-hash":(m=a.selectedPeer)==null?void 0:m.destination_hash,onConversationClick:n.onConversationClick,onPeerClick:n.onPeerClick},null,8,["conversations","peers","selected-destination-hash","onConversationClick","onPeerClick"]),e("div",Et,[M(o,{ref:"conversation-viewer","my-lxmf-address-hash":(_=a.config)==null?void 0:_.lxmf_address_hash,"selected-peer":a.selectedPeer,conversations:a.conversations,onClose:t[0]||(t[0]=x=>a.selectedPeer=null),onReloadConversations:n.getConversations},null,8,["my-lxmf-address-hash","selected-peer","conversations","onReloadConversations"])])],64)}const $t=C(zt,[["render",Wt]]);export{$t as default};
